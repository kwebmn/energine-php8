# Руководство по разметке компонентов Energine (Фаза 8.1)

## 1. Назначение и охват

Документ объясняет, как верстать Energine-компоненты с декларативной инициализацией.
Он опирается на соглашения Фазы 1 и маршрут миграции XSLT из Фазы 3 и предназначен для
разработчиков, которые переводят существующие шаблоны на атрибуты `data-energine-*`
или создают новые компоненты без инлайн-скриптов. Руководство охватывает:

- выбор контейнера компонента и размещение `data-energine-js`;
- описание параметров через `data-energine-param-*` и правила их именования;
- разметку тулбаров и вспомогательных узлов (переводы, порталы, виджеты);
- контроль последовательности и совместимости с наследием (`id`, стили, сторонние SDK);
- чек-лист проверки перед сдачей шаблона.

## 2. Предварительные требования

Перед применением инструкции убедитесь, что:

1. Компонент входит в реестр классов и параметров из документа «Соглашения по разметке»
   (Фаза 1). Если класс отсутствует или является исключением — добавьте его в словарь
   и уточните путь подключения по схеме Фазы 1.2.
2. Для шаблона существует запись в матрице миграции (Фаза 3.1). Если её нет — создайте
   строку, фиксирующую текущие инлайн-хуки, целевую разметку и исключения.
3. PHP-модель страницы передаёт в шаблон все значения, которые потребуется вставить в
   `data-energine-param-*`. При необходимости расширьте view-модель до начала правок XSLT.

## 3. Общая схема разметки

Следуйте однотипному процессу независимо от вида компонента:

1. **Найдите корневой элемент**, который фактически представляется JS-классом. Это может
   быть `<div>`, `<section>`, `<form>`, `<textarea>` и т.д. Он должен устойчиво существовать
   без генерации случайных `id`.
2. **Добавьте атрибут `data-energine-js`** со значением имени класса. Для цепочек
   (например, `GridManager` + `GridToolbar`) перечислите классы через пробел в порядке
   инициализации.
3. **Опишите обязательные параметры**. Используйте `data-energine-param-<kebab-case>`.
   Значения берем из XSLT-переменных или атрибутов XML. Для булевых параметров пишите
   `"true"/"false"`, для списков — значения через пробел. JSON и запятые не допускаются.
4. **Подготовьте дополнительные узлы**: слоты тулбара, переводов, вспомогательных
   компонентов (загрузчики, порталы). Они располагаются в структуре, описанной в разделе 5.
5. **Сохраните детерминированные идентификаторы**. Если ранее использовался `generate-id()`
   только ради JS, замените на надёжный селектор (например, `id="grid-${@id}"`). Если `id`
   нужен для CSS или сторонних интеграций — оставьте его и задокументируйте в листе
   исключений.
6. **Удалите инлайн-скрипты** из шаблона и замените их на декларативные узлы.
7. **Проверка**: убедитесь, что компонент, тулбар и переводы видны в DOM с корректными
   атрибутами. Сверьтесь с чек-листом из раздела 8.

## 4. Словарь параметров по классам

Используйте таблицу как практическую шпаргалку. Она агрегирует обязательные параметры из
Фазы 1 и дополнения Фазы 3.1. В столбце «Контейнер» указано, какой HTML-элемент обычно
помечается `data-energine-js`. Если класс используется в разных контекстах, укажите явный
селектор в примечаниях.

| Класс | Контейнер | Обязательные параметры | Частые дополнительные параметры | Примечания |
| --- | --- | --- | --- | --- |
| `GridManager` | `<section>`/`<div>` с сеткой | `data-energine-param-component`, `data-energine-param-template`, `data-energine-param-single-template` | `data-energine-param-quick-upload-path`, `-pid`, `-enabled`, `data-energine-param-move-from-id` | Если есть вложенные редакторы, добавляйте `data-energine-param-editor-*` пары. |
| `RecordSet` / `List` | Корневой контейнер списка | `data-energine-param-component`, `data-energine-param-template` | `data-energine-param-page-size`, `data-energine-param-autoload` | Для карточек с вкладками добавьте `data-energine-param-tab` с идентификатором. |
| `Form` | `<form>` | `data-energine-param-id` (machine id), `data-energine-param-action` (URL), `data-energine-param-method` | `data-energine-param-validator`, `data-energine-param-codemirror` ("true"), `data-energine-param-upload-target` | `id` формы должен оставаться согласованным с `<label for>`. |
| `FormUploader` / `AttachmentEditor` | Контейнер элемента загрузки | `data-energine-param-target`, `data-energine-param-resource` | `data-energine-param-multiple`, `data-energine-param-max-size` | Если компонент подвязан к тулбару, добавьте `data-energine-param-toolbar="id"`. |
| `PageEditor` | `<textarea>` | `data-energine-param-toolbar`, `data-energine-param-lang-id` | `data-energine-param-upload-path`, `data-energine-param-plugins` | Заголовок тулбара оформляйте отдельным слот-элементом. |
| `DivManager` | Основной блок дерева | `data-energine-param-component`, `data-energine-param-tree` | `data-energine-param-sidebars`, `data-energine-param-root-id` | Для синхронизации с боковыми панелями используйте общий идентификатор в параметрах. |
| `DivSidebar` | Боковая панель дерева | `data-energine-param-manager` (селектор `DivManager`) | `data-energine-param-mode`, `data-energine-param-toolbar` | Привязку к тулбару оформляйте через именованный слот. |
| `FiltersTreeEditor` / `FiltersEditor` | Контейнер фильтров | `data-energine-param-component`, `data-energine-param-target` (селектор сетки) | `data-energine-param-expanded`, `data-energine-param-ajax` | Следите за порядком инициализации: этот блок идёт после основной сетки. |
| `ImageManager` / `FileRepository` | Корень модального окна | `data-energine-param-resource`, `data-energine-param-mode` | `data-energine-param-folder`, `data-energine-param-allow-upload` | Тулбар модала — внутри контейнера, см. раздел 5. |
| `Player` | `<div>` или `<figure>` для плеера | `data-energine-param-source`, `data-energine-param-type` | `data-energine-param-autoplay`, `data-energine-param-poster` | Сохраняйте фиксированный `id`, если его читает внешняя библиотека. |
| `UserManager` | Блок виджета авторизации | `data-energine-param-providers` (список), `data-energine-param-callback-url` | `data-energine-param-required-fields`, `data-energine-param-redirect` | В dev-пайплайне PHP загрузчик подключит SDK по обнаруженным провайдерам. |
| `Toolbar` (портал) | `<div data-energine-toolbar>` | `data-energine-param-name`, `data-energine-param-target` | `data-energine-param-docking`, `data-energine-param-class` | Компонент создаёт контейнер; отдельные контролы описаны ниже. |
| `Toolbar.Button` / `Toolbar.Link` | `<button>`/`<a>` внутри слота | `data-energine-param-id`, `data-energine-param-action` | `data-energine-param-icon`, `data-energine-param-variant`, `data-energine-param-initially-disabled` | Текстовая подпись остаётся содержимым элемента. |
| `TranslationsExtend` | Вспомогательный `<div>` рядом с компонентом | `data-energine-param-source`, `data-energine-param-component` | `data-energine-param-scope` | Используйте, когда перевод загружается из скрытого `<script type="application/json">`. |

> **Совет.** Если компонент требует редкий параметр, которого нет в таблице, создайте новую
> строку и дополните словарь Phase 1.1, чтобы loader мог трансформировать имя в корректный
> ключ конструктора.

## 5. Тулбары и дополнительные узлы

### 5.1 Размещение слотов тулбара

1. После контейнера компонента выведите `<div data-energine-toolbar>` — это основное место
   для кнопок. Если требуется несколько зон, добавьте значение (например,
   `data-energine-toolbar="grid"`, `data-energine-toolbar="filters"`).
2. Для модальных окон помещайте слот внутри шапки/футера модала, чтобы визуальная
   иерархия не нарушалась.
3. Если тулбар нужно связать с конкретным экземпляром компонента, передайте идентификатор
   через `data-energine-param-target` (обычно `#<id-компонента>` или `[data-energine-js~="Class"]`).

### 5.2 Разметка контролов

- Каждый контрол — отдельный узел (`<button>`, `<a>`, `<li>` и т.п.) с `data-energine-js`
  соответствующего класса (`Toolbar.Button`, `Toolbar.Dropdown`, `Toolbar.Toggle`).
- Обязательные параметры: `data-energine-param-id` и `data-energine-param-action`.
- Дополнительные параметры передают визуальное оформление (`data-energine-param-variant`),
  иконки (`data-energine-param-icon`), состояния (`data-energine-param-disabled`).
- Вложенные группы оформляйте структурой DOM (например, `<div class="btn-group">…</div>`),
  а не инлайновым JS.

### 5.3 Переводы и вспомогательные блоки

- Источник переводов выводится как `<script type="application/json" data-energine-translations>`
  или `<div data-energine-translations>` (см. Phase 3.3). Компонент `TranslationsExtend`
  читает данные до старта основного класса.
- Если компонент требует хранилище конфигурации, используйте скрытые `<meta>`/
  `<script type="application/json">` с `data-energine-config` и привязывайте их через
  `data-energine-param-config` (селектор).

## 6. Работа с наследием и сторонними зависимостями

1. **Идентификаторы**. Зафиксируйте список `id`, которые нельзя менять (например, `player`,
   `componentToolbars`). Пропишите их в исключениях матрицы миграции и оставьте в DOM.
2. **Внешние библиотеки**. Для CKEditor, CodeMirror, jsTree/Fancytree и др. достаточно
   указать параметры (`data-energine-param-editor="ckeditor"`) — PHP loader подключит
   зависимости автоматически, исходя из правил Фазы 4.1.
3. **Порядок инициализации**. Когда несколько компонентов зависят друг от друга, расположите
   их контейнеры в DOM так, чтобы потребители шли после провайдеров (например, фильтры после
   сетки). Loader сохранит порядок из `data-energine-js`.
4. **Fallback-флаги**. Если страница может временно использовать старый JS, оберните новую
   разметку условием конфигурации, описанным в Фазе 7.3. При отключении флага верните старые
   узлы целиком, чтобы избежать смешанного состояния.

## 7. Пошаговые рецепты по основным семьям компонентов

### 7.1 Сетки и списки

1. Определите корневой блок (`<section class="grid">`).
2. Добавьте `data-energine-js="GridManager"` и параметры из таблицы (component/template).
3. Рядом выведите слот тулбара (`<div data-energine-toolbar="grid">`).
4. Если есть фильтры, оформите отдельный контейнер `FiltersTreeEditor` с ссылкой
   `data-energine-param-target="#grid-…"`.
5. Перенесите переводческие блоки в `TranslationsExtend` рядом с сеткой.

### 7.2 Формы и валидаторы

1. На `<form>` добавьте `data-energine-js="Form"` и параметры `id`, `action`, `method`.
2. Если требуется CodeMirror или вложенные редакторы — добавьте соответствующие
   `data-energine-param-*` флаги.
3. Вставьте слот тулбара перед футером (`<div data-energine-toolbar="form">`).
4. Для загрузчиков файлов добавьте дочерние узлы `FormUploader` с нужными параметрами.

### 7.3 Модальные окна и файловые менеджеры

1. Корневой `<div class="modal">` получает `data-energine-js="ImageManager"` либо другой
   класс и параметры (`resource`, `mode`).
2. Заголовок и футер модала содержат `data-energine-toolbar="modal"`.
3. Внутрь модала включите блок переводов или конфигурации, если требуется локализация.

### 7.4 Деревья и структуры сайта

1. Основной контейнер дерева — `data-energine-js="DivManager"`.
2. Боковые панели получают `data-energine-js="DivSidebar"` и параметр `manager` с селектором
   основного дерева.
3. Дополнительные тулбары (`tree`, `sidebar`) размещаются в соответствующих блоках.
4. Сохраните нужные `id` для ссылок и якорей.

### 7.5 WYSIWYG и редакторы контента

1. `<textarea>` помечается `data-energine-js="PageEditor"`.
2. Укажите `data-energine-param-toolbar`, `data-energine-param-lang-id` и другие настройки.
3. Тулбар редактора — `<div data-energine-toolbar="editor">` рядом с textarea.
4. Обеспечьте наличие переводов до инициализации через `TranslationsExtend`.

## 8. Чек-лист готовности шаблона

Перед публикацией убедитесь, что:

- [ ] Все компоненты имеют `data-energine-js` и актуальные параметры из словаря.
- [ ] Инлайн-скрипты, связанные с компонентом, удалены или перенесены в декларативные
      блоки.
- [ ] Тулбары и контролы размечены через `data-energine-toolbar` и `Toolbar.*` классы.
- [ ] Переводы подгружаются до запуска компонента, источники оформлены согласно Фазе 3.3.
- [ ] Учетные `id` и селекторы согласованы с CSS/SDK и отражены в исключениях.
- [ ] Страница корректно отрабатывает в debug=1 (отдельные скрипты) и debug=0 (бандлы).

## 9. Дополнительные материалы

- Соглашения по разметке Energine (Фаза 1) — базовые правила именования и примеры HTML.
- План миграции XSLT (Фаза 3.1) — готовые "было/стало" сценарии по шаблонам.
- Политика подключений внешних библиотек (Фаза 4.1) — чтобы понимать, когда loader
  добавит CKEditor, CodeMirror и другие UMD/ESM зависимости.
- План регрессионного тестирования (Фаза 7.1) — сценарии проверки после правок шаблона.

Соблюдение данного руководства гарантирует, что любой компонент Energine можно разметить
без инлайн-скриптов и подключить к новому единому загрузчику как в dev, так и в prod.
