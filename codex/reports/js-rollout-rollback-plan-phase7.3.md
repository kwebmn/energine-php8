# План включения и отката Energine JS-стека (Phase 7.3)

## 1. Цель и охват

- Обеспечить безопасный запуск новой JS-инфраструктуры (Phase 2–6) с возможностью точечного включения на страницах/шаблонах.
- Обеспечить быстрый возврат к legacy-схеме (ScriptLoader + `system.jsmap.php`) без деплоя кода, за счёт конфигурационных флагов.
- Распространяется на публичные и административные интерфейсы, задействующие Phase 3 декларативную разметку и Phase 5 бандлы.

## 2. Флаги и переключатели

| Уровень | Флаг/опция | Значение по умолчанию | Назначение | Связанные артефакты |
| --- | --- | --- | --- | --- |
| Глобальный (PHP config) | `js_pipeline.enabled` | `false` (legacy) | Включает новый сборщик списка скриптов (Phase 2.1) и единый лоадер (Phase 3.2). При `false` возвращаемся к ScriptLoader+`system.jsmap.php`. | Phase 2.1, Phase 3.2, Phase 6.1 |
| Глобальный (PHP config) | `js_pipeline.defer_only` | `true` | Принудительно помечает все `<script>` как неблокирующие (`defer`/`async`), соответствует политике Phase 2.2. При `false` возвращает синхронный режим для legacy-страниц, если требуется. | Phase 2.2 |
| Продакшн (PHP config/manifest) | `js_pipeline.prod_bundles` | `false` | При `true` XSLT ветки для `debug=0` подключают Vite-бандлы из `/assets` (Phase 5). При `false` — старый список файлов. | Phase 5.1, Phase 5.2 |
| Шаблон (XSL param) | `use_new_loader` | Наследует глобальный `js_pipeline.enabled` | Позволяет включить новый лоадер для конкретного шаблона (layout/head/body) или страницы, даже если глобально он выключен. | Phase 3.1, Phase 3.2 |
| Компонент (XSL attribute) | `data-energine-optin="true"` | `false` | Позволяет активировать декларативную инициализацию для выбранного компонента в смешанном окружении. При отсутствии атрибута компонент инициализируется legacy-скриптом. | Phase 3.1, Phase 3.2 |
| Админские внешние библиотеки | `js_pipeline.admin_bundle_only` | `false` | При `true` CKEditor/CodeMirror/jQuery/jsTree/FileAPI подключаются только из admin-бандла (Phase 4.1). При `false` — сохраняем раздельные файлы для постепенной миграции. | Phase 4.1 |

> **Примечание:** флаги могут храниться в `system.config.php`, `.env` или таблице настроек CMS; важно обеспечить чтение на ранней фазе генерации документа.

## 3. Процедура поэтапного включения

1. **Подготовка окружения**
   - Развернуть ветку с реализованными фазами 2–6.
   - Убедиться, что legacy ScriptLoader продолжает работать при `js_pipeline.enabled=false`.
2. **Тестовое включение (стенд/стейджинг)**
   - На стенде включить `js_pipeline.enabled=true`, `js_pipeline.prod_bundles=false`, `js_pipeline.defer_only=true`.
   - Активировать `use_new_loader=true` в шаблонах публичных страниц с минимальной функциональностью; включить `data-energine-optin` для выбранных компонентов.
   - Проверить переводы (Phase 3.3) и тулбары на совместимость.
3. **Постепенное расширение**
   - Добавлять новые шаблоны/страницы в список `use_new_loader` после успешного регресса (Phase 7.1).
   - Для админки включать `data-energine-optin` и контролировать внешние библиотеки через `js_pipeline.admin_bundle_only`.
4. **Включение prod-бандлов**
   - После подтверждения стабильности включить `js_pipeline.prod_bundles=true` на стенде.
   - Проверить загрузку `site.[hash].js`/`admin.[hash].js`, отсутствие лишних запросов (Phase 5.2, Phase 7.2).
5. **Промышленный релиз**
   - На продакшене включать флаги в той же последовательности: сперва `js_pipeline.enabled`, затем `use_new_loader` по шаблонам, затем `js_pipeline.prod_bundles`.
   - Вести журнал включений (дата, страница/шаблон, ответственный) для быстрых откатов.

## 4. Процедура отката

1. **Локализация проблемы** — определить, затрагивает ли ошибка конкретную страницу/компонент или весь стек.
2. **Точечный откат**
   - Отключить `data-energine-optin` на проблемном компоненте или вернуть `use_new_loader=false` для конкретного шаблона.
   - Очистить кэш браузера/HTTP для проверки.
3. **Глобальный откат**
   - Установить `js_pipeline.prod_bundles=false`, затем `js_pipeline.enabled=false`. Это вернёт legacy ScriptLoader и набор файлов из `scripts/`.
   - При необходимости отключить `js_pipeline.defer_only` для полного возвращения к синхронной загрузке.
   - Сохранить Vite артефакты, но исключить их из выдачи, чтобы ускорить повторный запуск.
4. **Пост-инцидентный анализ**
   - Зафиксировать причину, собрать логи/отчёты (Phase 3.2 диагностический лог), обновить чек-листы Phase 7.1.
   - Подготовить патч/фикс и повторить процедуру включения.

## 5. Диагностика и мониторинг флагов

- **Режим отчётности**: лоадер пишет в консоль браузера заметку о включённых флагах (Phase 3.2 diagnostic logging).
- **Серверные логи**: при генерации документа выводить в debug-лог активные флаги, список подключённых скриптов/бандлов.
- **Метрики**: сверяться с планом Phase 7.2 после включения каждого шага.

## 6. Критерии готовности к финальному включению

- Все шаблоны прошли регрессию по чек-листам Phase 7.1.
- План метрик Phase 7.2 подтверждён на контрольных страницах (нет деградации).
- Документация по флагам обновлена в setup/операционной инструкции.
- Настроен мониторинг и ответственные за оперативный откат.

## 7. Приложения и ссылки

- Phase 2.1 — сбор скриптов из DOM.
- Phase 3.1–3.3 — декларативная разметка, лоадер и переводы.
- Phase 4.1 — политика внешних библиотек.
- Phase 5.1–5.2 — Vite-бандлы и подключение.
- Phase 6.1–6.2 — удаление jsmap и упрощение setup.
- Phase 7.1–7.2 — регрессионные тесты и метрики.
