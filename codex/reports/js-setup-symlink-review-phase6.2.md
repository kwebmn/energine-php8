# Пересмотр механизма симлинков Setup (Phase 6.2)

## 1. Цель

- Определить, какие шаги Setup по созданию симлинков/копий статических файлов нужны после перехода на Vite-бандлы (Phase 5).
- Упростить процесс деплоя, устранив лишние операции, связанные с устаревшей схемой доставки JS.

## 2. Текущее состояние

- Установщик перебирает директории `images`, `scripts`, `stylesheets`, `templates/*` и для каждого модуля ядра/сайта создаёт симлинки в `htdocs` (в dev) или копирует/минифицирует файлы (в prod).【F:setup/Setup.class.php†L62-L110】【F:setup/Setup.class.php†L745-L1096】
- Поведение дублируется в `engine/setup/Setup.class.php`, которое используется при обновлениях движка.【F:engine/setup/Setup.class.php†L62-L1098】
- Для JS (`scripts`) режим prod включает минификацию/копирование через `JSqueeze`, чтобы получить автономный набор файлов в `htdocs/scripts/...`.【F:setup/Setup.class.php†L1010-L1096】
- Prod-страницы до миграции читали эти копии напрямую: XSLT вставляли `<script src="/scripts/...">` для каждого компонента.

## 3. Влияние новой схемы загрузки

- Фазы 2–3 переводят dev-режим на чтение оригинальных файлов модулей через декларативные атрибуты и правила резолвинга путей (с сохранением прямого доступа к `modules/*/scripts`).
- Фазы 5.1–5.2 меняют prod-режим: XSLT подключают только `site.[hash].js` и `admin.[hash].js` из `/assets` (Vite build). Отдельные `htdocs/scripts/*` больше не нужны для боевого режима.
- Внешние библиотеки (Phase 4.1) либо входят в admin-бандл, либо условно подключаются отдельными файлами, но только в dev/админ-кейсах.

## 4. Предложенные изменения Setup

### 4.1 Общие правила

1. **Разделить обработку директорий**: оставить `images`, `stylesheets`, `templates/*` без изменений (они по-прежнему нужны для обоих режимов), а для `scripts` применить новую логику.
2. **Ввести явный список директорий для dev/prod**: `scripts` участвует только в dev, остальные директории — в обоих режимах.
3. **Добавить создание каталога `/assets`** (если его нет) и очистку/заполнение по результатам `vite build` вместо генерации `scripts` для prod.

### 4.2 Dev (`debug=1`)

- Сохранить текущую схему симлинков для `scripts`: installer создаёт ссылки из `modules/*/scripts` в `htdocs/scripts/...`, чтобы dev-лоадер Phase 2.1 мог отдавать файлы напрямую.
- Продолжить симлинковать остальные директории (изображения, шаблоны) для быстрого обновления без копирования.
- Убедиться, что `/assets` не очищается в dev, чтобы не мешать параллельной локальной сборке (если разработчик запускает `vite build --watch`).

### 4.3 Prod (`debug=0`)

- **Пропустить директорию `scripts`**: не копировать и не минифицировать JavaScript через Setup; вместо этого очистить `htdocs/scripts` (если осталось историческое содержимое) и оставить пустой/символический файл `.gitkeep` при необходимости.
- **Сфокусироваться на `/assets`**: после `vite build` скопировать/синхронизировать итоговые бандлы (`site.[hash].js`, `admin.[hash].js`, CSS и вспомогательные chunks) в `htdocs/assets`. Setup может принимать путь к сборке (или рассчитывать `SITE_DIR/assets`) и выполнять только копирование манифеста и статических ресурсов.
- **Минификация/JSqueeze** больше не нужна: Vite выполняет оптимизацию JS/CSS. Удаление этого шага упростит код установщика и исключит дублирующую минификацию.
- Оставить копирование/симлинки для `images`, `stylesheets`, `templates/*`, пока они не перейдут под управление сборщика (отдельная задача).

### 4.4 Упрощение конфигурации

- В конфиге Setup (`$this->htdocsDirs`) выделить `scripts` в отдельный список или убрать полностью, чтобы избежать лишних проходов в prod.
- Для обратной совместимости предусмотреть флаг «legacy scripts», который можно временно включить, если не все компоненты перешли на новую схему (по умолчанию — выключен).
- Обновить текстовые сообщения Setup (логи) и документацию, чтобы разработчики знали про новый источник бандлов.

## 5. План внедрения

1. **Рефактор Setup**: вынести обработку `scripts` в отдельный метод, где логика зависит от `debug`/флагов. Дубликат в `engine/setup/Setup.class.php` синхронизировать.
2. **Очистить старые артефакты**: удалить из репозитория сгенерированные `htdocs/scripts/*` и связанные инструкции деплоя.
3. **Интегрировать с Phase 5**: убедиться, что шаг деплоя Vite вызывается до или внутри Setup, чтобы `htdocs/assets` заполнился до публикации.
4. **Обновить документацию**: добавить инструкцию в Phase 6 rollout checklist (6.1) о новой обязанности Setup и отказе от JSqueeze.
5. **Проверить сценарии**:
   - Dev: после установки страница грузит отдельные файлы из `htdocs/scripts/...` (симлинки работают).
   - Prod: страницы используют только `/assets/*.js` и не делают запросов к `scripts`.

## 6. Почему изменение безопасно

- Новая prod-схема (Phase 5) уже не опирается на раздачу отдельных JS-файлов, поэтому удаление копирования `scripts` не влияет на боевой режим.
- Dev остаётся без изменений, что сохраняет совместимость с существующей структурой модулей до полной миграции на bundled dev (если вообще понадобится).
- Удаление JSqueeze исключает двойную минификацию и ускоряет установку/деплой.

## 7. Открытые вопросы

- Нужно ли дополнительно оптимизировать `stylesheets` и `images` (например, тоже перевести на Vite)? Это выходит за рамки Phase 6.2, но стоит зафиксировать в бэклоге.
- Нужна ли обратная совместимость для проектов, где `scripts` ещё используются напрямую? Решается временным флагом в конфиге.

## 8. Чек-лист

- [ ] В Setup нет вызовов `JSqueeze` для prod-режима.
- [ ] Prod-режим не создаёт `htdocs/scripts/*` и заполняет только `/assets`.
- [ ] Dev-режим продолжает симлинковать `scripts` из модулей.
- [ ] Документация Setup обновлена, ссылка на Phase 5 бандлы добавлена.
- [ ] Проверены оба варианта (debug=1/0) на свежей установке.
