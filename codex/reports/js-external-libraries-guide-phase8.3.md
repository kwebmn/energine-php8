# Руководство по внешним библиотекам — Phase 8.3

## 1. Назначение и место в проекте

- Объяснить, как разработчику подключать и сопровождать внешние библиотеки Energine (CKEditor, CodeMirror, jQuery, jsTree,
  Fancytree, FileAPI) в рамках политики Phase 4.1.
- Зафиксировать пошаговые действия для режимов `debug=1` и `debug=0`, чтобы админские зависимости не попадали на
  публичные страницы.
- Служить рабочей памяткой при миграции шаблонов и обновлении карт зависимостей Phase 2.1/Phase 5.1.

## 2. Предварительные требования

Перед применением гайда убедитесь, что:

1. Компоненты размечены через `data-energine-js` и `data-energine-param-*` (Phase 1.1, Phase 3.1).
2. Карта «класс → библиотека» в PHP-лоадере актуальна (Phase 2.1, §4.1). Для каждого обнаруженного класса должна быть понятна
   принадлежность к admin/public и список нужных UMD-зависимостей.
3. Vite-точки входа `site`/`admin` соответствуют стратегии Phase 5.1 и уже содержат импорты библиотек, разрешённых таблицей Phase 4.1.

## 3. Быстрый справочник по библиотекам

| Библиотека | Основные компоненты | Dev (`debug=1`) | Prod (`debug=0`) | Зона по умолчанию |
|------------|---------------------|-----------------|-----------------|-------------------|
| CKEditor 4 | `Form`, `ValidForm`, `PageEditor`, `FormRichEditor`, тулбары WYSIWYG | Подключить `ckeditor.js` и используемые плагины отдельными `<script defer>` сразу после базового лоадера. Путь берём из `engine/core/modules/share/scripts/ckeditor/`. | Импортировать ядро и плагины в `admin` entry Vite. При сборке проверять, что глобальный `window.CKEDITOR` экспортируется (через `define` или `window`-присвоение). | Admin |
| CodeMirror | `FormCode`, `TemplateEditor`, поля с `data-energine-param-editor="code"` | Подключить ядро + требуемые `mode/*` и `addon/*` файлами `<script defer>`, CSS — `<link rel="stylesheet">`. Подключать только если есть хотя бы один соответствующий компонент. | Импортировать ядро/моды в `admin` entry; в `site` импортировать только когда публичные виджеты явно требуют подсветку. | Admin (по умолчанию) |
| jQuery | `DivManager`, `DivTree`, `DivSidebar`, старые публичные виджеты (`SignIn`, `SubscribeForm`) | Подключить `jquery.min.js` (до зависимых плагинов) только на страницах, где карта Phase 2.1 отмечает jQuery-компоненты. | Добавить импорт в `admin` entry. В `site` импортируется только если whitelist-компоненты реально присутствуют в DOM. | Admin |
| jsTree | `DivTree`, `FiltersTreeEditor` | Вставить `<script defer>` после jQuery. | Импортировать модуль в `admin` entry. | Admin |
| Fancytree | `SiteManager`, расширенные структуры | Дев: `<script defer>` после jQuery, подключаем файл `jquery.fancytree-all-deps.min.js`. | Прод: импортировать в `admin` entry, убедиться, что плагин и темы CSS добавлены. | Admin |
| FileAPI (+ плагины) | `FileRepository`, `AttachmentEditor`, `FormUploader`, интеграция с CKEditor | Дев: подключить `FileAPI.min.js`, `jquery.fileapi.min.js` и статические ассеты (`FileAPI.flash.swf`) только когда обнаружены FileAPI-компоненты. | Прод: импортировать JS в `admin` entry; статические файлы остаются в прежней директории и выдаются как статика. | Admin |

> **Важно:** если компонент больше не зависит от библиотеки, удалите его из карты Phase 2.1 и обновите entry-файлы Vite, чтобы исключить лишние импортируемые пакеты.

## 4. Процедура для режима разработки (`debug=1`)

1. **Определение потребности.** После генерации XSLT откройте итоговый HTML и убедитесь, что компоненты размечены корректно. PHP-лоадер
   вычислит набор библиотек автоматически. Если нужная зависимость не появилась, проверьте карту Phase 2.1.
2. **Подключение файлов.** Храним пути в конфигурации лоадера. Для каждого «vendor» добавляется `<script defer src="…">`
   (атрибуты по политике Phase 2.2). Сохраняйте порядок: jQuery → плагины → компонентные скрипты.
3. **Проверка админ/паблик.** На публичных страницах убедитесь, что Network-панель не содержит админских библиотек. Если
   появляется jQuery/CKEditor без соответствующих компонентов, исправьте карту и XSLT разметку.
4. **Отладка FileAPI.** Для Flash-падающих компонентов удостоверьтесь, что `FileAPI.staticPath` задаётся через `data-energine-param`
   и что SWF доступен по HTTP (иначе компонент не загрузится).
5. **Документация.** Любые временные исключения (например, ручное подключение скрипта в XSLT) фиксируются в Phase 4.1 таблице и
   планируются к устранению.

## 5. Процедура для production (`debug=0`)

1. **Импорты в Vite entry.** Для каждой библиотеки выполните `import` в нужном entry (`admin` или `site`). Используйте
   ленивую загрузку (`import()`), если библиотека нужна только после действия пользователя (например, открытие редактора).
2. **Сборка.** Запустите `vite build`. Убедитесь, что в `/assets` появился обновлённый `admin.[hash].js` (и `site.[hash].js`, если
   редактировали публичную часть). Проверяйте `manifest.json`, чтобы убедиться, что библиотеки действительно включены.
3. **Проверка бандла.** В DevTools → Coverage или через `vite build --analyze` убедитесь, что нет дублей библиотек и что
   admin-бандл не подключается на публичных страницах.
4. **Обновление PHP/XSLT.** Никакие дополнительные `<script>` в prod не добавляются — достаточно подключить `site/admin` бандлы
   (Phase 5.2). Если временно требуется прямое подключение (горячий фикс), задокументируйте и создайте задачу на возврат к бандлу.
5. **Регрессии.** После деплоя выполните smoke-тесты из Phase 7.1: редакторы, деревья, загрузчики файлов. Особое внимание — тому,
   что переводчики и тулбары инициализируются до загрузки библиотек (Phase 3.3).

## 6. Контроль отсутствия «лишних» библиотек

- **Автотест:** добавьте шаг в регрессионный чек-лист Phase 7.1 — на публичных страницах запрещены запросы к `ckeditor`,
  `jquery`, `FileAPI`, `fancytree`, `jstree`, `codemirror`, если соответствующего компонента нет в DOM.
- **Мониторинг:** при релизах анализируйте Webpack Bundle Analyzer / Vite `--analyze` отчёты; рост admin-бандла >15 % требует
  ревью зависимостей.
- **Code review:** любые изменения в карте зависимостей или entry-файлах должны проходить ревью с проверкой соответствия таблице
  §3. Нарушения (например, импорт jQuery в `site` без публичного компонента) отклоняются.

## 7. FAQ

- **Вопрос:** компонент в админке использует CKEditor, но в dev библиотека не грузится. Что делать?
  **Ответ:** убедитесь, что `data-energine-js` соответствует записи в карте Phase 2.1. Если компонент переименован, обновите карту и
  таблицу §3. После обновления пересоберите список скриптов, очистив кеши.
- **Вопрос:** нужно подключить новую библиотеку (например, Chart.js) только для конкретного виджета.
  **Ответ:** добавьте запись в карту Phase 2.1 (укажите область и путь) и обновите таблицу §3. В prod импортируйте библиотеку в
  соответствующий Vite entry. Убедитесь, что публичные страницы без виджета её не тянут.
- **Вопрос:** можно ли оставить библиотеку на CDN?
  **Ответ:** допускается только для внешних сервисов (OAuth и т. п.). В остальных случаях придерживаемся локальных файлов и Vite
  бандлов, чтобы управлять зависимостями и кешированием.

## 8. Чек-лист разработчика

1. Проверить, что компонент размечен декларативно (`data-energine-js`).
2. Убедиться, что карта Phase 2.1 содержит правильную запись о библиотеке и области применения.
3. В dev убедиться, что библиотека подключена только там, где компонент реально присутствует.
4. В prod — обновить импорты в Vite entry и пересобрать `vite build` → проверить, что публичные страницы грузят только `site.*`.
5. Заполнить журнал изменений: что подключено, где используется, есть ли временные исключения.
6. Отметить прохождение smoke-тестов для админских сценариев (редактор, деревья, загрузка файлов).

