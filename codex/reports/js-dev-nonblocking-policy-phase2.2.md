# Политика неблокирующей загрузки для debug=1 (Фаза 2.2)

## 1. Цель и зона действия

Этап 2.2 расширяет работу дев-лоадера (Phase 2.1) требованиями по неблокирующей
подключаемости. Все `<script>`-теги, сформированные сервером при `debug=1`,
должны исключать блокировку парсинга HTML и одновременно сохранять рабочий
порядок выполнения, заданный очередью PHP (`Document::finalizeJavascriptQueue`).

Политика распространяется на все скрипты, которые выводятся XSLT через
`<document/javascript>` и `<document/javascript/library>`, включая ядро Energine,
внешние библиотеки, компонентные файлы и единый загрузчик атрибутов.

## 2. Базовые правила подключения

| Категория скрипта | Источник | Атрибуты | Обоснование |
| --- | --- | --- | --- |
| Ядро Energine (`Energine.js`) | локальный | `defer` | Гарантирует выполнение после разбора DOM, но до `DOMContentLoaded`, при этом не блокирует парсинг документа. |
| Лоадер атрибутов (`energine-loader.dev.js`) | локальный | `type="module"` + `crossorigin="anonymous"` (для согласованности с Vite в prod) | Модульные скрипты выполняются автоматически в режиме `defer`, не блокируют парсер и предоставляют `import`/`await` для динамических зависимостей. |
| Базовые утилиты (`Cookie.js`, `ModalBox.js`, …) | локальный | `defer` | Требуют последовательного выполнения перед компонентами, совместимы с `defer`. |
| Компонентные классы | локальный | `defer` | Порядок исполнения контролируется порядком `<script>` в разметке; `defer` сохраняет этот порядок. |
| Вендорные зависимости (jQuery, jsTree, CKEditor, FileAPI, CodeMirror, Fancytree) | локальный | `defer` | Большинство библиотек зависят от jQuery/ядра; `defer` гарантирует последовательность. |
| Внешние CDN (`https://vk.com/js/api/openapi.js`, Facebook SDK и др.) | внешние | `async defer` + `crossorigin` (если требуется CORS) | Разрешает браузеру не блокировать парсинг и загружать внешний код параллельно; потенциальные зависимости подключаются через колбэки/события готовности. |
| Диагностические/отладочные вставки (если останутся) | локальный | `defer` | Любые временные скрипты также обязаны быть неблокирующими. |

Дополнительные указания:

- Для локальных скриптов `async` не используется, чтобы не нарушить порядок
  инициализации. Исключение — внешние вставки, которые самостоятельно
  уведомляют о готовности (VK/Facebook).
- Для модульного загрузчика (`type="module"`) браузер автоматически включает
  отложенное выполнение. Остальные скрипты остаются классическими, но с `defer`.
- `nomodule` не применяется, так как dev-режим ориентирован на современные
  браузеры разработчиков.

## 3. Обеспечение порядка выполнения

1. PHP-очередь формируется в Phase 2.1: `[ядро] → [вендоры] → [компоненты]`.
2. XSLT печатает `<script>` в полученном порядке. Согласно спецификации HTML,
   все `defer`-скрипты исполняются последовательно, в порядке появления, после
   полного парсинга документа и до события `DOMContentLoaded`.
3. Для модульного загрузчика действует тот же порядок: браузер гарантирует, что
   он выполнится после ядра, если ядро идёт раньше в документе.
4. Если конкретная библиотека требует быть загруженной строго перед другим
   скриптом (например, `jquery.min.js` перед `jquery.fileapi.min.js`), порядок
   закрепляется в PHP-списке и автоматически соблюдается при `defer`.
5. В случаях, когда внешняя вставка (`async defer`) должна быть готова до
   запуска определённого компонента, соответствующий компонент обязан ожидать
   событие загрузки (например, `VK.Widgets.onWidgetsReady`). Это зафиксировано
   в спецификации компонентной логики и не нарушается переходом на неблокирующий
   режим.

## 4. Совместимость и обратная связь

- Старые страницы, полагавшиеся на немедленное выполнение `script` сразу после
  тега, переписаны в Phase 1 на декларативный запуск через лоадер; поэтому
  переход на `defer` не ломает их логику.
- При обнаружении новых зависимостей, не поддерживающих `defer`, разработчик
  обязан адаптировать компонент к ленивому старту (через события DOM или
  промисы лоадера). Добавление блочного скрипта запрещено.
- Метрика Lighthouse/DevTools «блокирующие скрипты» должна показывать 0 для
  локальных ресурсов в debug-режиме. При ручном тестировании страницы
  должны визуально и функционально работать как до изменения.

## 5. Контрольный чек-лист внедрения

- [ ] Dev-страницы рендерят `<script>` только с `defer` или `type="module"`.
- [ ] Внешние CDN получают `async defer` и корректные `crossorigin`/`referrerpolicy`.
- [ ] Проверен порядок выполнения зависимых библиотек (jQuery → плагины → компоненты).
- [ ] Вёрстка и интерактивность на ключевых страницах (админ и публичные) совпадают
      с исходной функциональностью.
- [ ] Инструменты разработчика фиксируют отсутствие блокирующих скриптов.
