# План регрессионного тестирования Energine JS-стека (Phase 7.1)

## 1. Цели

- Подтвердить, что переход на декларативную инициализацию, новый dev-лоадер и prod-бандлы не вносят функциональных регрессий.
- Проверить ключевые пользовательские сценарии в публичной части и админке под управлением обновлённых правил загрузки скриптов и переводов.
- Зафиксировать единые чек-листы для прогонов в режимах `debug=1` (dev) и `debug=0` (prod).

## 2. Область покрытия

- **Компоненты списков и пагинации**: каталог, ленты новостей, таблицы, списки категорий.
- **Формы и валидация**: публичные формы обратной связи, админские формы редактирования сущностей.
- **Модальные окна и диалоги**: всплывающие подтверждения, диалоги редактирования.
- **Редактор контента**: CKEditor, CodeMirror и связанные тулбары.
- **Дерево и иерархии**: jsTree/Fancytree в админке, навигационные деревья.
- **Загрузка файлов**: FileAPI/загрузчик, просмотрщик изображений.
- **Тулбары и кнопки действий**: верхние панели, контекстные кнопки.
- **Переводы и локализация**: доступность строк переводов до старта компонентов.
- **Порядок загрузки и зависимости**: гарантии неблокирующей загрузки и корректного порядка выполнения.

## 3. Предпосылки и подготовка окружения

1. **Dev-прогон (`debug=1`)**
   - Установлен проект с симлинками скриптов и новым PHP-лоадером Phase 2.
   - Включены расширенные логи диагностики лоадера (консоль/Network).
   - Очистить кэш браузера перед проверкой.
2. **Prod-прогон (`debug=0`)**
   - Выполнен `vite build` Phase 5; в `/assets` доступны `site.[hash].js` и при необходимости `admin.[hash].js`.
   - Включён новый механизм подключения бандлов в XSLT (Phase 5.2).
   - Удалены старые `htdocs/scripts/*`, чтобы исключить ложные зависимости.
3. **Общее**
   - Имеются тестовые учётные записи с правами пользователя и администратора.
   - Настроены фикстуры данных: контент в списках, формы, файлы для загрузки.

## 4. Матрица сценариев

| Категория | Публичные страницы | Админка |
| --- | --- | --- |
| Списки / пагинация | Каталог товаров, новостная лента | Список страниц/материалов, управление пользователями |
| Формы | Обратная связь, подписка на рассылку | Форма редактирования страницы, создание записи |
| Модальные окна | Уведомления, подтверждение отправки формы | Диалог редактирования записи, подтверждение удаления |
| Редакторы | (нет) | CKEditor для контента, CodeMirror для шаблонов |
| Деревья | Навигационное меню (если применимо) | Структура сайта в jsTree/Fancytree |
| Загрузка файлов | Публичный аплоад (если есть) | Медиа-менеджер, загрузка изображений/FileAPI |
| Тулбары | Публичные кнопки действий (если есть) | Верхние панели администратора, контекстные тулбары |
| Переводы | Проверка локализации интерфейса | Переводы UI, сообщений в админке |
| Зависимости | Проверка отсутствия блокирующих `<script>` | Проверка порядка загрузки CKEditor/CodeMirror/jQuery |

## 5. Чек-лист DEV (`debug=1`)

### 5.1 Публичная часть

- [ ] Страницы со списками загружаются без ошибок консоли; пагинация работает, скрипты подхватываются неблокирующе.
- [ ] AJAX/динамические списки (фильтры, сортировка) инициализируются через `data-energine-js`; при переключениях не наблюдается повторных загрузок одинаковых файлов.
- [ ] Публичные формы валидируются и отправляются; ошибки отображаются корректно; повторное открытие формы не требует inline-скриптов.
- [ ] Модальные окна/диалоги открываются и закрываются, события привязаны через декларативный лоадер.
- [ ] Тулбар/кнопки действий (если есть) получают активные состояния и локализованные подписи до запуска компонентов.
- [ ] Переводы доступны в консоли (`Energine.i18n`), лоадер не стартует до их загрузки.
- [ ] Network-профиль подтверждает отсутствие `<script>` без `defer`/`async` и нет блокирующих запросов.

### 5.2 Админка

- [ ] Авторизация администратора проходит; после входа загружаются только требуемые админские скрипты.
- [ ] Список страниц/материалов инициализируется; сортировка, фильтрация и массовые действия работают.
- [ ] Формы редактирования используют CKEditor/CodeMirror по месту; редакторы подключаются динамически и не появляются на страницах, где не нужны.
- [ ] Дерево сайта (jsTree/Fancytree) загружается, операции перетаскивания и контекстное меню функционируют.
- [ ] Модальные окна (создание страницы, подтверждение удаления) корректно подписаны и не зависят от inline-кода.
- [ ] Файловый менеджер загружает изображения, предпросмотр работает; FileAPI подключается только на соответствующей странице.
- [ ] Тулбары и кнопки действий доступны, команды выполняются, перевод строк соответствует выбранной локали.
- [ ] Диагностика: консоль не содержит ошибок `ScriptLoader`/`system.jsmap`; новые логи лоадера подтверждают успешную инициализацию компонентов в порядке очереди.

## 6. Чек-лист PROD (`debug=0`)

### 6.1 Публичная часть

- [ ] В исходном HTML присутствуют только ссылки на `site.[hash].js` (и сопутствующие CSS/chunk-файлы, если есть); дополнительные `<script>` отсутствуют.
- [ ] Сценарии списков/пагинации работают так же, как в dev; при обновлении страницы используется кеш бандла, нет лишних запросов к `scripts/`.
- [ ] Публичные формы, модальные окна и тулбары функционируют; локализация доступна до инициализации компонентов.
- [ ] Lighthouse/DevTools не показывают блокирующих скриптов; бандл загружается с атрибутами `defer`/эквивалентными.

### 6.2 Админка

- [ ] При входе администратора подключаются `site.[hash].js` и `admin.[hash].js`; отсутствуют обращения к старым `scripts/*.js`.
- [ ] Админские списки, деревья и тулбары работают; проверены массовые действия, перетаскивания, фильтры.
- [ ] CKEditor/CodeMirror доступны, локализация и тулбары подгружены; нет ошибок инициализации.
- [ ] Загрузка файлов и предпросмотр корректны; бандл содержит необходимые FileAPI/UMD-библиотеки.
- [ ] Переключение языков/переводов обновляет интерфейс; компоненты не стартуют до готовности переводов.
- [ ] Проверены fallback-сценарии: отключение одного из chunk-файлов вызывает предсказуемую ошибку в логах (для мониторинга).

## 7. Управление дефектами и критерии завершения

- Все пункты чек-листов DEV и PROD отмечены как пройденные без блокирующих дефектов.
- Найденные дефекты классифицированы (Blocker/Critical/Major/Minor) и занесены в регистр, устранены перед релизом.
- Повторные прогоны выполняются после исправлений, чтобы подтвердить закрытие регрессий.

## 8. Дополнительные рекомендации

- Автоматизировать smoke-тесты для публичных страниц (например, через Playwright) после стабилизации API лоадера.
- Включить мониторинг Production: ошибки JS, время загрузки бандлов, метрики отказов при инициализации компонентов.
- Зафиксировать ответственных за выполнение прогонов и расписание (до/после деплоя, регрессы после изменений Phase 3–6).
