# Депривация system.jsmap.php и ScriptLoader-зависимостей (Phase 6.1)

## 1. Цель

- Финально удалить `system.jsmap.php`, логику его генерации и все вызовы PHP, зависящие от legacy jsmap.
- Убедиться, что dev (`debug=1`) и prod (`debug=0`) режимы продолжают собирать корректный набор скриптов на основе фаз 2–5.
- Обезопасить миграцию компонентов, постепенно переводя их с `ScriptLoader.load(...)` на декларативные атрибуты из Phase 1.

## 2. Текущее наследие и точки использования

| Узел | Назначение | Комментарий |
|------|------------|-------------|
| `engine/core/modules/share/gears/Document.class.php` (`build()` → блок «// Javascript dependencies») | Подключает `system.jsmap.php`, запускает `createJavascriptDependencies()` и добавляет `<javascript/library>` в итоговый XML. | Основной потребитель jsmap в рантайме. Без файла список `<script>` в dev пуст. |
| `Document::createJavascriptDependencies()` | Рекурсивно плоско раскрывает дерево зависимостей из jsmap. | Заточен под массив вида `['GridManager' => ['TabPane', ...]]`. |
| `setup/Setup.class.php` и `engine/setup/Setup.class.php` (`parseScriptLoader()` + `writeJSMap()`) | Во время установки/обновления анализируют JS-файлы на наличие `ScriptLoader.load(...)` и пишут `system.jsmap.php`. | Дублируют код в двух пространствах имён. |
| `system.jsmap.php` | Сгенерированный массив зависимостей компонент → вспомогательные классы. | Используется только PHP-рантаймом. |
| JS-файлы c `ScriptLoader.load(...)` (см. Phase 0 inventory) | Декларируют зависимости для генератора jsmap. | После перехода на Phase 3 loader эти вызовы становятся артефактами. |

Дополнительно: XSLT-шаблоны опираются на `<document/javascript/library>` (см. Phase 0) для формирования `<script>` во всех режимах. В Phase 2.1 планируется заменить источник списка скриптов на DOM-сканер.

## 3. Предпосылки и зависимые результаты

- **Phase 2.1** — сервер собирает JS-список из `data-energine-js`, заменяя jsmap при `debug=1`.
- **Phase 2.2** — определены неблокирующие атрибуты для `<script>`.
- **Phase 3.1–3.3** — XSLT мигрируют на `data-energine-*`, loader запускает компоненты без inline-скриптов, переводы доступны заранее.
- **Phase 4.1** — политика подключения внешних UMD/ESM библиотек (условно для админки).
- **Phase 5.1–5.2** — prod бандлы `site.[hash].js`/`admin.[hash].js` подключаются через manifest.

## 4. План удаления

### 4.1 Подготовительные шаги

1. **Включить новый dev-лоадер (Phase 2.1)**: `Document::build()` после трансформации получает список компонентов, но теперь вместо jsmap формирует `<javascript/library>` из DOM-сканера.
2. **Актуализировать XSLT (Phase 3.1)**: все компоненты передают `data-energine-js` и параметры. Никакие шаблоны не зависят от `generate-id()` ради JS.
3. **Перенести подключения внешних библиотек** на условные правила (Phase 4.1), чтобы dev-список мог определить, нужен ли jQuery/CKEditor и т.д., без jsmap.
4. **Прод-ветки переключить на бандлы** (Phase 5.2). После этого prod не обращается к jsmap даже косвенно.

### 4.2 Замена рантайм-логики

| Что меняем | Действие | Замена/источник |
|------------|----------|-----------------|
| `Document::build()` блок чтения `system.jsmap.php` | Удалить подключение файла, рекурсивный вызов `createJavascriptDependencies()`, формирование `<javascript/library>` из jsmap. | Добавить вызов сервиса Phase 2.1, который получает массив `devScripts` (`loader.js`, компоненты, вендоры) и на его основе создаёт `<javascript/library>`. |
| `Document::createJavascriptDependencies()` | Удалить метод. | Результат Phase 2.1 поставляет уже плоский список. |
| Обработка `<document/javascript/library>` в XSLT | Оставить интерфейс, но источник теперь — DOM-сканер (dev) или manifest (prod). | Без изменений в XSLT, только в данных. |

### 4.3 Очистка установщика и генератора jsmap

| Узел | Действие |
|------|----------|
| `Setup::writeJSMap()` и `Setup::parseScriptLoader()` (оба пространства имён) | Удалить методы, вызовы и точки, где они запускаются. Процесс установки больше не генерирует jsmap. |
| Вызовы `ScriptLoader.load(...)` в JS | Перевести на пустые shim-функции либо удалить (внутри Phase 3.2 loader), поскольку зависимости теперь описываются в dev-процедуре Phase 2.1 или входят в Vite-бандлы. |
| Файл `system.jsmap.php` | Удалить из репозитория/артефактов деплоя. |

### 4.4 Финальная проверка сценариев

1. **Dev (`debug=1`)**:
   - PHP собирает `devScripts` через DOM-сканер и правило Phase 1.2.
   - XSLT выводят `<script>` неблокирующе (Phase 2.2).
   - Внешние библиотеки подключаются условно (Phase 4.1).
2. **Prod (`debug=0`)**:
   - PHP resolve'ит manifest и отдаёт `site`/`admin` бандлы (Phase 5.2).
   - Доп. файлы из jsmap не требуются — всё внутри Vite-пакета.
3. **Инсталлятор/обновления**:
   - Исключить шаг генерации jsmap.
   - Обновить документацию/скрипты деплоя: `system.jsmap.php` больше не создаётся.

## 5. Почему безопасно

- Все компоненты и внешние библиотеки уже покрыты новой схемой загрузки (фазы 2–5).
- Dev и prod пути используют одни и те же декларативные атрибуты, поэтому отсутствие jsmap не ломает разметку.
- Переход устраняет дублирование зависимостей между PHP и бандлами, снижая риск рассинхронизации.

## 6. Чек-лист удаления

- [ ] В `Document.class.php` нет ссылок на `system.jsmap.php` или `createJavascriptDependencies()`.
- [ ] В кодовой базе отсутствуют вызовы `Setup::writeJSMap()`/`parseScriptLoader()` и сам файл `system.jsmap.php`.
- [ ] `ScriptLoader.load(...)` либо удалён, либо превращён в no-op до полной миграции компонентов.
- [ ] Dev-страницы загружаются без ошибок 404 на скриптах; порядок инициализации совпадает с Phase 2.2.
- [ ] Prod-страницы используют только бандлы и внешние файлы согласно Phase 4.1.
- [ ] Документация деплоя обновлена: нет инструкций про генерацию jsmap.

## 7. Связи с другими задачами

- Требует завершения Phase 2.1–2.2 и Phase 5.1–5.2 (полноценные источники скриптов без jsmap).
- Поддерживает Phase 3.2 (единый loader) и Phase 3.3 (переводы до инициализации).
- Упрощает Phase 4.1 (условная загрузка библиотек) — больше нет необходимости поддерживать устаревшие цепочки зависимостей.
