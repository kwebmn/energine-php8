# Политика подключения внешних библиотек (Фаза 4.1)

## 1. Цель и охват

Сформировать единый регламент загрузки UMD/ESM-зависимостей Energine — CKEditor, CodeMirror, jQuery с деревьями
(jsTree/Fancytree) и FileAPI — так, чтобы:

- в режиме разработки (`debug=1`) подключались только необходимые файлы и только на страницах, где они реально нужны;
- в production (`debug=0`) все админские зависимости попадали в бандл(ы) Vite (`admin.[hash].js`), а публичные страницы
  не тянули лишние скрипты;
- сохранилась совместимость с текущими XSLT/компонентами и плагинами.

Политика опирается на инвентаризацию Phase 0 (места использования библиотек) и на логику dev-лоадера из Phase 2.1–2.2.

## 2. Общие правила

1. **Определение области (admin/public)** — сервер вычисляет принадлежность страницы к административной части по текущему
   флагу `Document::isAdmin()` (или эквивалентному признаку). Все правила ниже применяются только если страница админская,
   иначе библиотека вообще не рассматривается, за исключением jQuery/CodeMirror на отдельных публичных виджетах (см. таблицу).
2. **Dev-режим** — скрипты подключаются как отдельные файлы из репозитория. Очередь формирует PHP-лоадер (Phase 2.1), XSLT
   выводят `<script defer src="…">`. CSS (например, CodeMirror) продолжает подключаться через `<link>` в XSLT.
3. **Prod-режим** — Vite-бандл `admin.[hash].js` включает все админские UMD/ESM-зависимости. Публичные страницы используют
   либо общий `site.[hash].js`, либо внешние CDN (если это публичная интеграция). Подключение внешних файлов напрямую в
   проде допускается только для сторонних OAuth API (VK/Facebook) — они остаются вне этой таблицы.
4. **Условная загрузка** — список компонент → библиотека берётся из Phase 2.1. Если компонент отсутствует в DOM, библиотеку
   не добавляем.
5. **Совместимость плагинов** — при переносе в бандл проверить, что плагины (например, CKEditor `filebrowser`, FileAPI
   плагины) попадают в тот же бандл и продолжают экспортировать глобальные объекты (`window.CKEDITOR`, `window.FileAPI`).

## 3. Матрица подключений

| Библиотека / пакет | Где используется (по компонентам / шаблонам) | Dev (debug=1) | Prod (debug=0) | Область по умолчанию |
| --- | --- | --- | --- | --- |
| **CKEditor 4** (`engine/core/modules/share/scripts/ckeditor/ckeditor.js` + плагины) | Формы и редакторы контента: `Form`, `ValidForm`, `PageEditor`, `FormRichEditor`, `CKToolbar` | Подключать отдельным `<script defer>` в админке, когда обнаружен любой из перечисленных классов. Опционально добавлять адаптер `ckeditor/adapters/jquery.js`, если компонент его требует. | Включить целиком в `admin.[hash].js` (ядро + используемые плагины). В проде отдельный `<script>` не выводится. | Admin. Публичные страницы исключить, даже если компонент ошибочно добавлен. |
| **CodeMirror** (`engine/core/modules/share/scripts/CodeMirror/...`) | Поля ввода кода, шаблонов, SQL: компоненты `FormCode`, `TemplateEditor`, поля с `data-energine-param-editor="code"`. | Загружать ядро и необходимые модули (`mode/*`, `addon/*`) отдельными `<script defer>` только там, где в DOM присутствуют элементы с параметром редактора. CSS подключается через `<link>`. | Включить ядро и используемые модули в `admin.[hash].js`. Публичный `site.[hash].js` получает только те моды, что требуются для публичных виджетов (если таковые есть). | Admin по умолчанию; Public — только если компонент явно помечен (например, публичный CodeMirror-подсветчик) через Phase 1 атрибуты. |
| **jQuery** (`engine/core/modules/share/scripts/jquery.min.js`) | Админские менеджеры и деревья: `DivManager`, `DivTree`, `DivSidebar`, `FiltersTreeEditor`, некоторые формы. В публичной части — старые виджеты авторизации/подписок, если ещё не переписаны. | Подключать отдельным файлом в админке, если обнаружен любой jQuery-зависимый класс. Публичные страницы получают jQuery только при наличии компонента из whitelist (например, `SignIn`, `SubscribeForm`). | В админке jQuery входит в `admin.[hash].js`. В публичном бандле включать только если есть компоненты-устаревшие зависящие от jQuery; иначе оставить вне `site.[hash].js` и не подключать. | Admin. Public — только для whitelist-компонентов. |
| **jsTree** (`engine/core/modules/share/scripts/jstree/jstree.js`) | Админские деревья (`DivTree`, `DivManager`, `FiltersTreeEditor`). | Дев: отдельный `<script defer>` после jQuery, только на админ-страницах с соответствующими компонентами. | Прод: включить в `admin.[hash].js` рядом с jQuery. | Admin. |
| **Fancytree** (`engine/core/modules/share/scripts/fancytree/jquery.fancytree-all-deps.min.js`) | Расширенные деревья в админке (`SiteManager`, спец. редакторы структуры). | Дев: отдельный `<script defer>` после jQuery. Подключать только при обнаружении `SiteManager` или иных компонентов из списка Phase 0. | Прод: бандлить в `admin.[hash].js`. | Admin. |
| **FileAPI** (`engine/core/modules/share/scripts/FileAPI/*.js`) | Загрузчики файлов: `FileRepository`, `FileRepoForm`, `AttachmentEditor`, `FormUploader`, WYSIWYG-плагины. | Дев: подключать `FileAPI.min.js`, `FileAPI.flash.swf` (статик) и `jquery.fileapi.min.js` по необходимости, только на админ-страницах с соответствующими компонентами. Настраивать `FileAPI.staticPath` через data-атрибут лоадера. | Прод: включить ядро и jQuery-плагин в `admin.[hash].js`, статические ассеты (SWF, изображения) остаются в файловой системе. | Admin. |
| **jQuery File Upload / иные плагины** (если ещё используются) | Старые формы загрузки файлов. | Дев: подключать отдельными файлами по тем же правилам, что FileAPI. | Прод: мигрировать в `admin.[hash].js` либо заменить на FileAPI. | Admin (deprecated). |

## 4. Правила условного подключения

1. На сервере поддерживать карту `class → vendor` из Phase 2.1. Таблица выше определяет, к какой области относится правило.
2. При обработке DOM в dev-режиме:
   - Если страница админская — применить все админские правила.
   - Если публичная — применить только те правила, где область включает Public (jQuery/CodeMirror whitelist).
3. Перед добавлением в очередь проверить, что библиотека ещё не включена (защита от дубликатов).
4. В production сборка Vite получает список библиотек из той же карты: билдер добавляет `import` в точку входа `admin` (и, при
   необходимости, `site`). На стороне PHP/XSLT остаётся только подключение итогового бандла, никаких индивидуальных `<script>`.

## 5. Совместимость и переходные шаги

- **Старые inline-инициализации** — до полной миграции XSLT возможно, что компоненты продолжают требовать глобальные
  переменные (`window.CKEDITOR`). При бандлинге удостовериться, что Vite экспортирует их в `window`. Для dev-режима
  порядок `Energine.js` → `jquery.min.js` → плагины → компоненты сохраняется (см. Phase 2.2).
- **Модули без jQuery** — если компонент обновлён на нативный JS, удалить его из карты зависимостей, чтобы jQuery не тянулся
  лишний раз.
- **Откат** — в случае проблем допускается временно оставить библиотеку отдельным `<script>` и в проде, но это фиксируется в
  таблице как исключение и требует отдельного таска на перенос в бандл.

## 6. Чек-лист при внедрении

1. Актуализировать карту зависимостей в PHP-лоадере (Phase 2.1) по таблице из §3.
2. Обновить точки входа Vite (`admin/main.ts`, `site/main.ts`) — добавить `import` соответствующих библиотек.
3. Проверить, что admin-бандл загружает библиотеки один раз, а публичные страницы не тянут их.
4. Прогнать smoke-тесты в dev: формы с CKEditor, деревья, загрузчики файлов, CodeMirror.
5. Собрать prod-билд Vite и убедиться, что зависимости присутствуют в `admin.[hash].js`, а DOM не содержит отдельных `<script>`.
6. Документировать исключения (если есть) и запланировать их устранение.
