# План метрик производительности Energine JS-стека (Phase 7.2)

## 1. Цели и ожидаемые эффекты

- **Исключение блокирующих скриптов в dev (`debug=1`)** — подтверждаем выполнение политики Phase 2.2: все `<script>` грузятся неблокирующе, порядок исполнения сохранён.
- **Сокращение количества запросов в prod (`debug=0`)** — после Phase 5 подключаются только `site.[hash].js` и при необходимости `admin.[hash].js`, без рассыпанных файлов из `scripts/`.
- **Улучшение ключевых Web Vitals** — зафиксировать целевые пороги для First Contentful Paint (FCP) и Largest Contentful Paint (LCP) на типовых публичных страницах.

## 2. Целевые пороги и допущения

| Метрика | Цель | Дополнительные условия |
| --- | --- | --- |
| Блокирующие скрипты | `0` синхронных `<script>` без `defer`/`async` в dev и prod | Проверяется через вкладку Network/Performance в DevTools.
| Количество JS-запросов | ≤ 3 запросов на JS в prod: `site.[hash].js`, `admin.[hash].js` (админка), динамические chunk’и (опционально) | Допускаются ленивые chunk’и, если нужны для позднего функционала.
| FCP | ≤ 1.5 сек на десктопе, ≤ 2.5 сек на мобильном профиле | Замеры Lighthouse/Chrome UX Report (эмуляция Pixel 5, Slow 4G). 
| LCP | ≤ 2.5 сек на десктопе, ≤ 3.5 сек на мобильном профиле | Тот же набор инструментов; оценка на главной и страницах списков.

## 3. Методика измерения

### 3.1 Dev (`debug=1`)

1. **Подготовка**
   - Развернуть окружение с включённым новым PHP-лоадером Phase 2 и декларативной разметкой Phase 3.
   - Очистить кэш браузера и включить throttling (Slow 3G/CPU ×4) для стресс-теста.
2. **Проверка блокирующих скриптов**
   - В Chrome DevTools (вкладка Network) отфильтровать ресурсы типа Script и убедиться, что все они помечены как `defer`/`async`/`module`.
   - Вкладка Performance — зафиксировать отсутствие Long Tasks, связанных с parsing blocking scripts.
3. **Замер FCP/LCP (контрольный)**
   - В DevTools Lighthouse прогнать мобильный и десктопный профили, зафиксировать значения FCP/LCP для сравнения с prod.

### 3.2 Prod (`debug=0`)

1. **Подготовка**
   - Выполнить `vite build` (Phase 5); убедиться, что в `/assets` лежат актуальные бандлы с хешами.
   - Обновить XSLT-шаблоны (Phase 5.2), очистить CDN/HTTP-кеши.
2. **Контроль количества запросов**
   - Через DevTools Network или WebPageTest зафиксировать, что запрошены только `site.[hash].js` (+`admin.[hash].js` для админки) и связанные chunk’и.
   - Проверить, что обращения к `scripts/` отсутствуют (можно использовать фильтр `-domain:scripts`).
3. **Web Vitals**
   - Выполнить Lighthouse-аудит для мобильного и десктопного профиля (несколько прогонов, усреднить).
   - При наличии доступа к лабораторным данным (WebPageTest) — сравнить FCP/LCP, Speed Index, Total Blocking Time.
   - Зафиксировать результаты в таблице «до/после», цель — укладываться в пороги из §2.
4. **Production Monitoring**
   - Настроить сбор реальных метрик (Real User Monitoring) через существующий analytics/бэкэнд: FCP/LCP, TBT, количество загруженных скриптов.
   - Определить частоту выборки (например, 1 раз в неделю после релиза) и ответственных за анализ тренда.

## 4. Порядок проверки и отчётность

1. **Базовый прогон (до изменений)** — зафиксировать текущие значения FCP/LCP и число запросов на контрольных страницах (главная, типовой список, карточка, админская форма).
2. **Контрольный прогон (после внедрения Phase 2–6)** — повторить измерения; сравнить дельту с базой.
3. **Регулярный мониторинг**
   - Еженедельно анализировать RUM-данные и отчёты Lighthouse.
   - При деградации (>10 % от целевого порога) инициировать расследование: проверить бандлы, chunk split, подключение внешних библиотек.
4. **Отчётность**
   - Хранить результаты в общем репозитории (папка `codex/metrics/` или Confluence).
   - В отчёте фиксировать дату, режим (dev/prod), страницу, устройство, сеть, значения FCP/LCP, количество запросов, комментарии.

## 5. Риски и меры смягчения

- **Нестабильность метрик в dev** — использовать dev-замеры только для контроля наличия блокирующих скриптов; производственные пороги проверяются в prod.
- **Рост размера бандла** — мониторить Vite bundle report (`--analyze`), при превышении 250 КБ gzipped выделять отдельные chunk’и.
- **Дополнительные внешние библиотеки** — следить, чтобы подключение CKEditor/CodeMirror/FileAPI не вносило лишние запросы (см. Phase 4.1).
- **Сетевые колебания** — повторять измерения не менее 3 раз, усреднять значения, фиксировать условия.

## 6. Критерии приёмки

- Выполнены шаги проверки §3–4 для dev и prod режимов.
- Отсутствуют синхронные `<script>` без `defer`/`async`/`module` в обоих режимах.
- Количество JS-запросов в prod соответствует целям (не более 3 на страницу).
- FCP/LCP на контрольных страницах укладываются в целевые пороги; при отклонениях подготовлен план оптимизации (lazy chunks, критический CSS, оптимизация медиа).
- Настроен регулярный мониторинг с ответственными лицами и расписанием.
