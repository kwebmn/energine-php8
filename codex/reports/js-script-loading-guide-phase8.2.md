# Руководство по подключению скриптов (dev/prod) — Phase 8.2

## 1. Цель

- Пояснить, как сервер формирует список `<script>`-подключений в debug-режиме (`debug=1`) без `system.jsmap.php`.
- Описать prod-процесс: из чего состоит Vite-сборка, где лежат артефакты и как подключаются бандлы при `debug=0`.
- Дать разработчикам пошаговые инструкции по обновлению подключений при добавлении/удалении компонентов и внешних библиотек.

## 2. Исходные данные и зависимости

- Phase 2.1: серверная процедура сканирования DOM по `data-energine-js` и построение списка файлов.
- Phase 2.2: политика неблокирующей загрузки (`type="module"` + `defer`/`async`/`crossorigin` по матрице).
- Phase 4.1: правила условного подключения CKEditor, CodeMirror, jQuery, jsTree/Fancytree, FileAPI.
- Phase 5.1: структура Vite build (входы `site`/`admin`, вывод `/assets`, хешированные имена, `manifest.json`).
- Phase 5.2: XSLT-ветки prod-режима, переключение на бандлы без изменения макета шаблонов.

## 3. Режим разработки (debug=1)

### 3.1 Формирование списка скриптов

1. **Сканирование DOM:** после построения XML-документа PHP выполняет XPath-запрос и собирает уникальные значения `data-energine-js`.
2. **Резолв пути:** имена классов маппятся на файлы по правилу Phase 1.2 (`components/<ClassName>.js` и т. д.), исключения — через явную карту.
3. **Обязательные файлы:** в начало списка добавляются базовый лоадер, утилиты ядра, переводчик, диагностические инструменты.
4. **Внешние библиотеки:** по результатам шага 1 определяется, нужны ли админские UMD-зависимости; подключаются только для страниц, где встретились соответствующие компоненты (см. Phase 4.1).
5. **Порядок:** список сортируется так, чтобы:
   - ядро шло первым,
   - компоненты следовали в порядке обнаружения (или по приоритетам, если заданы),
   - полифилы/админ-библиотеки добавлялись в конце, если требуется.
6. **Передача в XSLT:** PHP передаёт итоговый массив в шаблоны (например, параметр `scripts`), сохраняя существующие точки вывода.

### 3.2 Подключение и неблокирующие атрибуты

- Каждое подключение производится через `<script type="module" src="…" defer></script>` либо комбинацию из матрицы Phase 2.2 (для UMD-бандлов — `defer` + «порядок»).
- Если порядок критичен (например, jQuery → плагин), XSLT выводят обёртку (например, `data-priority`) или PHP сортирует список заранее.
- Статические JSON/переводы подключаются до лоадера (Phase 3.3), но также неблокирующе (`<script type="application/json"` без блокировки парсера).

### 3.3 Что делает разработчик в debug

| Сценарий | Действия | Что обновляется |
|----------|----------|-----------------|
| Добавление нового компонента | 1) Прописать `data-energine-js` в шаблоне.<br>2) Создать JS-файл по правилу Phase 1.2.<br>3) При необходимости добавить исключение в карту. | Конфигурация карты путей (если компонент вне правила). |
| Удаление компонента | Удалить атрибуты `data-energine-*` из XSLT. | Ничего — сервер перестанет включать файл автоматически. |
| Подключение внешней UMD-библиотеки | Обновить Phase 4.1 список условий и расположение файлов. | Таблицы условного подключения, документировать зависимость. |

### 3.4 Проверка в debug

- Убедиться, что `system.jsmap.php` не вызывается.
- В DevTools → Network нет `blocking` скриптов; все новые файлы с `type="module"` / `defer`.
- При добавлении компонента он появляется в списке скриптов без ручного редактирования XSLT.

## 4. Режим production (debug=0)

### 4.1 Сборка бандлов

1. **Точки входа:** `site/main.ts|js` и `admin/main.ts|js` (точные пути зафиксированы в Phase 5.1). Они импортируют нужные компоненты и внешние библиотеки согласно политике Phase 4.1.
2. **Команда сборки:** `vite build` (без dev-сервера) с конфигурацией, выводящей файлы в `/assets` и создающей `manifest.json`.
3. **Артефакты:** минимум два JS-файла (`site.[hash].js`, `admin.[hash].js`) + связанные CSS/asset-чанки. Хеш в имени обеспечивает cache busting.
4. **Публикация:** содержимое `/assets` копируется на сервер приложения; старые файлы можно удалить для чистоты.

### 4.2 Подключение в шаблонах

- В XSLT prod-ветка запрашивает у PHP готовые пути из `manifest.json` и выводит по одному `<script>`:
  - публичные страницы — только `site.*`;
  - админские — `site.*` + `admin.*` (в указанном порядке).
- `<link rel="stylesheet">` для CSS, если Vite сгенерировал отдельные файлы.
- Атрибуты (`type="module" defer crossorigin`) соответствуют политике Phase 2.2; порядок `<script>` сохранён.
- Асинхронные чанки, динамический импорт подтягиваются браузером автоматически — никаких дополнительных `<script>` не требуется.

### 4.3 Обновление при изменении компонентов

| Изменение | Действия в prod | Комментарии |
|-----------|-----------------|-------------|
| Добавлен компонент | 1) Импортировать его в нужный entry (`site`/`admin`).<br>2) Запустить `vite build` → обновить `/assets` + `manifest.json`.<br>3) Убедиться, что prod-ветка XSLT не hardcode'ит список файлов. | Dev уже подключает класс автоматически; prod требует пересборки. |
| Удалён компонент | Удалить импорт из entry, пересобрать Vite. | Старые чанки можно удалить после деплоя. |
| Обновлена внешняя библиотека | Внести изменения в `admin` entry и/или `package.json`, пересобрать. | Убедиться, что библиотека не нужна на публичной стороне, если она тяжёлая. |

### 4.4 Обновление бандлов

- Регламент: при каждом релизе JS — `npm ci` → `npm run build` (`vite build`) → деплой `/assets` + `manifest.json`.
- После деплоя проверить:
  - манифест доступен PHP;
  - XSLT выводят новые хеши;
  - браузер не кэширует старые файлы (можно настроить `Cache-Control: immutable`).

## 5. Сводные рекомендации

1. **Единый источник правды:** в debug доверяем серверному списку, в prod — `manifest.json`. Не редактируем XSLT вручную под конкретные файлы.
2. **Диагностика:** при появлении пустого `<script>` или 404 на файл проверить:
   - карту соответствия классов;
   - наличие записи в манифесте;
   - корректность деплоя `/assets`.
3. **Совместимость:** на время миграции допускается временное чтение старых атрибутов (Phase 3.2), но цели — полностью перейти на `data-energine-*`.
4. **Документация:** изменения в правилах подключения отражать в соответствующих Phase-доках (2.1, 4.1, 5.1, 5.2) и в этом гайде.

## 6. Чек-лист разработчика

- [ ] В debug-режиме новый компонент появляется на странице без ручных правок шаблона.
- [ ] В prod после пересборки подключается ровно тот же набор компонентов (через бандлы).
- [ ] Внешние библиотеки не загружаются на страницах, где не нужны.
- [ ] В DevTools нет предупреждений о блокирующих `<script>`.
- [ ] Переводы доступны до старта лоадера (Phase 3.3).

## 7. Ссылки на родственные документы

- Phase 2.1 — Dev loader: `codex/reports/js-dev-loader-phase2.1.md`.
- Phase 2.2 — Политика неблокирующих `<script>`: `codex/reports/js-dev-nonblocking-policy-phase2.2.md`.
- Phase 4.1 — Внешние библиотеки: `codex/reports/js-external-libraries-policy-phase4.1.md`.
- Phase 5.1 — Prod build стратегия: `codex/reports/js-prod-build-strategy-phase5.1.md`.
- Phase 5.2 — Prod подключение бандлов: `codex/reports/js-prod-bundle-integration-phase5.2.md`.
- Phase 8.1 — Разметка компонентов: `codex/reports/js-component-markup-guide-phase8.1.md`.
