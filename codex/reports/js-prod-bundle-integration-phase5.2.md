# Подключение production-бандлов в XSLT (Phase 5.2)

## 1. Цель

- Заменить набор legacy-скриптов на хешированные Vite-бандлы при `$DOC_PROPS[@name='debug']='0'`.
- Сохранить текущие позиции `<script>` в XSLT-шаблонах, меняя только значения `src`/`href` и атрибуты.
- Поддержать неблокирующую загрузку, согласованную с политикой Phase 2.2.

## 2. Исходные данные

- Manifest (`/assets/manifest.json`) содержит соответствие логических имён `site` и `admin` хешированным файлам `site.[hash].js`/`admin.[hash].js` (и CSS, если есть).
- PHP при генерации документа знает: страница публичная или административная (флаг `Document::isAdmin()` или аналогичный).
- В debug-режиме (`debug=1`) XSLT по-прежнему получают список отдельных файлов от серверного загрузчика (Phase 2.1).

## 3. Общий алгоритм для debug=0

1. **Выбор режима**: PHP выставляет параметр `debug` во входных данных XSLT. Все шаблоны с подключениями проверяют `debug`. При значении `0` переходят в prod-ветку.
2. **Получение путей**: до трансформации PHP resolve'ит имена `site` и `admin` через `manifest.json` и подставляет готовые абсолютные/относительные URL (например, `/assets/site.abcd1234.js`).
3. **Формирование списка подключений**:
   - Публичные страницы: только `site`-бандл (`site.[hash].js`), плюс сопутствующий CSS (`<link rel="stylesheet">`), если указан в `manifest`.
   - Административные страницы: `site` + `admin` (JS и CSS), причём `site` выводится первым для сохранения общего рантайма.
4. **Неблокирующие атрибуты**: для JS применяются атрибуты, заданные политикой Phase 2.2 (например, `type="module"` + `crossorigin`/`defer` по необходимости). CSS подключается через `<link rel="stylesheet">` с `media="all"`.
5. **Сохранение точек подключения**: каждое место, где XSLT раньше выводил `<script>` для отдельных файлов, теперь выводит ровно один `<script>`-элемент, содержащий путь к бандлу, сохраняя окружение (комментарии, порядок, обёртки).
6. **Диагностика**: при отсутствии нужного ключа в `manifest` PHP формирует fallback (напр., логирует ошибку и не выводит `<script>`), чтобы не нарушить XSLT.

## 4. Шаблоны XSLT: матрица перехода

| Шаблон/область | Было (debug=1/legacy) | Станет (debug=0) | Порядок/атрибуты |
|----------------|------------------------|------------------|------------------|
| Общий `<head>` публичной части | Список `<script>` и `<link>` по списку dev-файлов | Один `<script src="/assets/site.[hash].js" type="module" defer>` и (при наличии) `<link rel="stylesheet" href="/assets/site.[hash].css">` | `site` всегда первым JS; `defer`/`type="module"` по Phase 2.2 |
| Общий `<head>` админки | Те же dev-файлы + внешние библиотеки | Последовательно `<script src="/assets/site.[hash].js" ...>`, затем `<script src="/assets/admin.[hash].js" ...>`, плюс CSS линк(и) | `site` → `admin`; оба неблокирующие |
| Доп. вставки в теле (если были) | Dev-скрипты компонентов | Не требуются — бандлы покрывают всё. Остальные места отключаются условием по `debug`. | — |

## 5. Особые случаи

- **Асинхронные чанки**: генерируются Vite автоматически и подгружаются браузером, поэтому XSLT не должны подключать их явно.
- **Плагины внешних библиотек**: если по политике Phase 4.1 решено оставить UMD-файлы отдельными даже в prod, их условные подключения сохраняются рядом, но они применяются редко (исключения должны быть перечислены отдельно).
- **Переводы**: загрузка данных переводов должна оставаться до старта лоадера. Если переводы отдаются отдельным `<script type="application/json">`, их подключение не меняется.

## 6. Проверка

- [ ] В шаблонах нет ссылок на устаревшие `system.jsmap.php`/dev-файлы в prod-ветке.
- [ ] Все `<script>` в prod имеют неблокирующие атрибуты согласно Phase 2.2.
- [ ] Для админских страниц одновременно подключаются `site` и `admin` (в указанном порядке).
- [ ] При обновлении бандлов достаточно очистить `/assets` и перезаписать `manifest.json`.
- [ ] В dev-ветке поведение не изменено.

## 7. Взаимосвязи с другими фазами

- Зависит от Phase 5.1 (наличие `manifest.json` и структуры `/assets`).
- Использует результаты Phase 2.1/2.2 для определения атрибутов и списка обязательных файлов в debug.
- Требует готового лоадера Phase 3.2 и переводы (Phase 3.3) внутри бандлов.

