# energine-php8

## Ресайзинг изображений

Система предоставляет контроллер `/img/{path}` для безопасного изменения размеров изображений "на лету" на основе [Glide](https://glide.thephpleague.com/). Запросы необходимо подписывать HMAC-параметром `s`, что защищает от подбора и скрывает внутреннюю структуру хранения.

### Конфигурация

Параметры берутся из блока `images` в `system.config.php`:

- `enabled` — включение сервиса (1/0).
- `base_url` — базовый префикс URL (по умолчанию `/img`).
- `source` — путь к исходным файлам, например `var/storage/images`.
- `cache` — директория файлового кеша Glide.
- `defaults` — параметры по умолчанию (`fit`, `q` и др.).
- `sign_key` — секрет для подписи URL.
- `cache_max_age` — время жизни файлов в кеше (сек).
- `gc_interval` — как часто запускать автоматическую чистку (сек).

### Поддерживаемые параметры

| имя | описание | значения |
| --- | --- | --- |
| `w`, `h` | ширина и высота в пикселях | 1‑2560, `w*h` ≤ 4 000 000 |
| `fit` | способ вписывания изображения | `crop`, `max`, `fill`, `contain`, `stretch` |
| `q` | качество для JPEG/WebP/AVIF | 40‑95, по умолчанию 80 |
| `fm` | выходной формат | `jpeg`, `png`, `webp`, `avif`* |
| `dpr` | коэффициент плотности пикселей | `1`, `2`, `3` |
| `s` | HMAC‑подпись | обязательный параметр |

\* форматы зависят от поддержки расширений PHP и клиентов.

### Генерация ссылок в PHP

Используйте глобальные хелперы:

```php
// Обычный URL
$url = glide_url('uploads/public/demo.jpg', ['w' => 800]);

// Srcset
$srcset = glide_srcset('uploads/public/demo.jpg', [400, 800, 1200], ['fit' => 'crop']);
```

Функции автоматически добавляют подпись `s`.

### Совместимость

Старые адреса вида `/resizer/w800-h600/path/to.jpg` продолжают работать и проксируются в новый контроллер. Дополнительные параметры (`fit`, `fm`, `q`, `dpr`, `s`) можно передавать через query string.

### Кеширование

Готовые изображения сохраняются в директории, заданной `images.cache`. При повторном запросе файл отдаётся напрямую. HTTP‑заголовки включают:

```
Cache-Control: public, max-age=31536000, immutable
ETag, Last-Modified
```

Ленивый сборщик мусора периодически удаляет файлы старше `cache_max_age`. Очистка запускается не чаще чем раз в `gc_interval` секунд при обращениях к изображению, поэтому отдельный cron не требуется.

Пример настройки nginx для отдачи кеша без участия PHP:

```nginx
location ^~ /img/ {
    try_files $uri $uri/ @php;
}
location @php {
    fastcgi_pass   php-fpm:9000;
    include        fastcgi_params;
    fastcgi_param  SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param  QUERY_STRING    $query_string;
}

# Совместимость
location ^~ /resizer/ {
    try_files $uri @php;
}
```

### Очистка кеша

Для удаления сгенерированных файлов воспользуйтесь CLI-командой:

```
bin/console image:clear-cache
```

Очистить кеш только для одного пути:

```
bin/console image:clear-cache --path=uploads/public/demo.jpg
```

### Ограничения безопасности

- Путь `path` должен находиться в пределах разрешённых корней.
- Запрос без корректной подписи в production отдаёт 403.
- Превышение лимитов размеров возвращает 400.
