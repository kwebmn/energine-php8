# Setup 2 — руководство по запуску и интеграции

## Требования

* PHP 8.3 или новее с поддержкой CLI и веб-SAPI.
* Установленные расширения: opcache, pdo, mbstring, json, curl, openssl, dom, SimpleXML, fileinfo. Необязательные, но рекомендованные: intl, zip, gd.
* Доступ к Composer для установки зависимостей проекта (`vendor/autoload.php` обязателен для запуска установщика).

## Подготовка окружения

1. Клонируйте репозиторий и перейдите в корневую директорию проекта.
2. Установите зависимости:
   ```bash
   composer install
   ```
3. Проверьте права на запись для директорий, с которыми работает установщик. Они должны существовать (или иметь возможность быть созданными) и быть доступны на запись пользователю, под которым запускается PHP:
   * `var/`
   * `var/cache/`
   * `var/log/`
   * `var/export/`
   * `uploads/`
   * `uploads/public/`
   * `uploads/temp/`

   Если каталоги отсутствуют, их можно создать и выдать права командой вида:
   ```bash
   mkdir -p var/cache var/log var/export uploads/public uploads/temp
   chmod -R 775 var uploads
   ```

## Включение режима разработчика

Веб-интерфейс установщика доступен только в режиме разработчика. Параметр хранится в файле `system.config.php` в корне проекта:

```php
return [
    'site' => [
        'debug' => 1,
    ],
    // ...
];
```

Установите значение `['site']['debug']` в `1`, чтобы разрешить доступ к Setup 2 через браузер. При `0` веб-версия закрыта, и вход будет заблокирован. После завершения установки верните параметр в `0`, если проект работает в production-среде.

## Использование CLI-интерфейса

1. Используйте синтаксис `php setup2/index.php <действие>`. Например, для проверки окружения выполните:
   ```bash
   php setup2/index.php check-env
   ```
   Допустимо использовать как `check-env`, так и `checkEnv`. Скрипт вернёт статус и детализированную информацию о проверках.
2. Для запуска других действий подставьте нужное имя из списка доступных, например:
   ```bash
   php setup2/index.php install
   php setup2/index.php clear-cache
   ```
   Установщик поддерживает `install`, `clear-cache`, `sync-uploads`, `export-trans`, `uninstall`, `check-env` и другие сценарии, доступные в меню.

## Действие `linker`

`linker` автоматизирует создание и обновление символических ссылок на модули и их ресурсы по аналогии со старым установщиком. Оно считывает список модулей из `system.config.php`, пересоздаёт ссылки в каталоге модулей ядра (путь берётся из `core_rel_dir`, по умолчанию — `core/modules`) и синхронизирует статические файлы (`images/`, `scripts/`, `stylesheets/`, `templates/*` и т.д.) из папок модулей в рабочие директории проекта. Действие полезно после обновления репозитория, добавления новых модулей или переноса проекта — когда требуется быстро привести структуру ссылок к актуальному состоянию.

* При включённом режиме отладки (`site.debug = 1`) все ресурсы размещаются через символические ссылки, что ускоряет разработку и позволяет сразу видеть изменения в исходных файлах.
* При выключенном режиме (`site.debug = 0`) статические файлы копируются, чтобы исключить зависимость от исходных директорий при работе в production-среде.

Для запуска через CLI выполните:

```bash
php setup2/cli.php linker
```

В веб-интерфейсе откройте Setup 2 (при `site.debug = 1`), перейдите на главную страницу установщика и запустите действие «Linker» из списка доступных операций.

Обратите внимание, что PHP-процесс, под которым запускается действие, должен иметь права на создание символических ссылок в директориях проекта. На Linux/Unix это означает права на запись в целевые каталоги; на Windows может потребоваться запуск от имени администратора или включённый «Developer Mode». При невозможности создать ссылку действие укажет ошибку в отчёте, после чего можно повторно выполнить `linker` после исправления прав.

## Веб-интерфейс

1. Убедитесь, что в `system.config.php` включён режим разработчика (`['site']['debug'] = 1`). Если значение равно `0`, Setup 2 вернёт отказ в доступе.
2. При необходимости включите Basic Auth, задав переменные окружения перед запуском сервера:
   ```bash
   export SETUP2_USER="admin"
   export SETUP2_PASS="secret"
   ```
3. Запустите встроенный PHP-сервер из корня проекта (в качестве документа-источника используется `index.php`):
   ```bash
   php -S 127.0.0.1:8000 index.php
   ```
   Альтернативно настройте любой веб-сервер (Nginx/Apache), указывая корневой каталог проекта и предоставляя доступ к `setup2/index.php`.
4. Откройте `http://127.0.0.1:8000/setup2/index.php` в браузере. Если Basic Auth включён, авторизуйтесь, используя логин и пароль из переменных окружения.
5. На панели «Действия» выберите нужную задачу. После запуска результат и лог отобразятся в правом блоке. Все формы защищены CSRF-токеном, повторный запуск возможен сразу после завершения предыдущего действия.

## Проверка готовности

Для подтверждения готовности к интеграции выполните:

1. CLI-проверку окружения (см. выше) — все обязательные пункты должны пройти без ошибок.
2. Тестовый запуск через веб-интерфейс (например, `Check Env`) и убедитесь, что лог успешно отображается.

После этого Setup 2 готов к дальнейшей интеграции или развертыванию.
