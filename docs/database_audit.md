# Отчет по аудиту базы данных

Ниже зафиксированы результаты проверки `database.sql` на предмет отсутствующих внешних ключей и фактических нарушений ссылочной целостности.

## Отсутствующие внешние ключи

* **`auto_Testfeed_filter_translation`** — таблица хранит переводы фильтров, но не защищена от некорректных значений `filter_id` и `lang_id`: внешние ключи к `auto_Testfeed_filter` и `share_languages` отсутствуют.【F:database.sql†L125-L132】
* **`auto_test_filter_translation`** — аналогично предыдущему пункту, перевод может ссылаться на несуществующие фильтр или язык, потому что нет ограничений на `filter_id` и `lang_id`. Необходимо добавить связи с `auto_test_filter` и `share_languages`.【F:database.sql†L431-L438】
* **`share_sitemap_tags`** — таблица связи между разделами и тегами не содержит ограничений на `smap_id` и `tag_id`, поэтому в неё можно поместить значения, которых нет в `share_sitemap` или `share_tags`. Требуются внешние ключи на обе таблицы.【F:database.sql†L8700-L8705】
* **`share_sitemap_uploads`** — для колонок `smap_id` и `session_id` не определены внешние ключи, тогда как `smap_id` должен ссылаться на `share_sitemap`, а `session_id` — на `share_session.session_native_id`. Сейчас ограничение есть только на `upl_id`.【F:database.sql†L8856-L8867】
* **`share_sites_properties`** — значения `site_id` никак не валидируются и могут ссылаться на несуществующие сайты, поскольку внешнего ключа на `share_sites` нет.【F:database.sql†L8918-L8926】
* **`share_sites_tags`** — таблица связывает сайты и теги, но не накладывает ограничений на `site_id` и `tag_id`. Следует добавить ключи к `share_sites` и `share_tags`.【F:database.sql†L8951-L8956】
* **`share_session`** — колонка `u_id` лишь индексируется и может содержать идентификаторы несуществующих пользователей. Рекомендуется ввести ограничение на `user_users(u_id)`.【F:database.sql†L8610-L8624】
* **`auto_test_uploads`** — поле `session_id` предназначено для связи с таблицей сессий, но ограничение не задано; допустимы произвольные значения, что осложняет очистку устаревших загрузок. Следует добавить внешний ключ на `share_session.session_native_id`.【F:database.sql†L540-L551】
* **`auto_Testfeed_uploads`** — аналогичная проблема: `session_id` не связан с `share_session`, поэтому записи могут ссылаться на несуществующие сессии. Рекомендуется добавить ограничение на `share_session.session_native_id`.【F:database.sql†L204-L213】

## Выявленные несоответствия данных

* **Несуществующие разделы в `share_sitemap_tags`** — в таблице присутствуют строки с `smap_id = 3731, 3735, 3736, 3738, 3739`, однако в `share_sitemap` этих узлов нет, что говорит о «висячих» привязках тегов.【F:database.sql†L8674-L8689】【F:database.sql†L8714-L8728】
* **Свойства сайтов, назначенные сайту `0`** — все записи `share_sites_properties` указывают на `site_id = 0`, но в `share_sites` существует только сайт с идентификатором `1`. Эти свойства фактически висят без владельца.【F:database.sql†L8906-L8907】【F:database.sql†L8935-L8940】
* **Загрузка без действительной сессии** — запись `auto_test_uploads` использует `session_id = '6c0f29096a5d446d2acee6f1bca6e877'`, которого нет в выгруженных данных `share_session`. Такая загрузка не сможет пройти проверку после добавления ограничений и требует очистки или корректировки.【F:database.sql†L561-L561】【F:database.sql†L8634-L8636】

## Рекомендации

1. Добавить перечисленные внешние ключи. Перед созданием ограничений следует очистить выявленные некорректные данные, иначе команды `ALTER TABLE` завершатся с ошибками.
2. Удалить или восстановить отсутствующие сущности, чтобы устранить «висячие» ссылки (в частности, записи в `share_sitemap_tags` и свойства с `site_id = 0`).
3. Настроить регулярную проверку (например, SQL-запросы в cron) на предмет ссылочных нарушений, чтобы новые аномалии обнаруживались заранее.
