# Руководство по работе с XSLT в Energine

> TL;DR — импортируйте ядро через `engine/core/modules/share/transformers/include.xslt`,
> используйте публичные режимы (`field_name`, `field_input`, `field_messages`,
> `grid_cell`, `filter_control`, `head`) и держите разметку декларативной.

## 1. Архитектура модулей

* **Точка входа** — `site/modules/default/transformers/include.xslt`.
  Сайт импортирует ядро через `xsl:import`, затем подключает свои стили.
* **Бандл ядра** — `engine/core/modules/share/transformers/include.xslt`.
  Он импортирует `base.xslt` и включает остальные публичные шаблоны.
* **Разделённые поля** — весь функционал полей вынесен в `/fields/*.xslt`,
  общие атомы лежат в `fields/helpers.xslt`, классы — в `classes.xslt`.

## 2. Публичные режимы и атомы

| Шаблон/режим             | Назначение                                                         |
|--------------------------|--------------------------------------------------------------------|
| `field_name`             | Заголовок/лейбл поля, содержит `data-role="form-field"` оболочку. |
| `field_input`            | Интерактивный контрол, используют атомы атрибутов.                 |
| `field_messages`         | Ошибки и подсказки (без DOE, rich-text через `xsl:copy-of`).        |
| `FORM_ELEMENT_ATTRIBUTES`| id/name/required/maxlength и `nrgn:*`-атрибуты для edit режима.    |
| `FORM_ELEMENT_ATTRIBUTES_READONLY` | Скрытые поля, синхронизированные с readonly выводом.     |
| `class.*`                | Макросы классов Bootstrap (`class.form-control`, `class.form-select`).|
| `grid_cell`, `filter_control` | Грид и фильтры списков. Используйте, если добавляете колонки. |
| `head`                   | Режим для `<head>`, переопределяется в site-модуле.                |

**Запрещено:**

* Добавлять `disable-output-escaping`.
* Ручной `id`/`name`/`required` в полях — только атомы.
* Удалять вызовы `generate-id()` или менять их результат.

## 3. Производительность

* Для повторных выборок используйте `xsl:key` + `key()` (варианты: опции полей,
  контролы тулбаров, переводы по компонентам).
* Избегайте `//` в шаблонах — кэшируйте выражения в переменных.
* В продакшене включён XSLT-кеш (`document.xslcache=1`); убедитесь, что расширение доступно.

## 4. Переопределения

1. Добавьте новый файл в `site/modules/.../transformers/` и подключите его в
   `include.xslt` *после* импорта ядра.
2. Используйте `xsl:template match="..." priority="..."` для точечного override.
3. Если нужен новый публичный API — задокументируйте шаблон в шапке файла и
   обновите этот гайд.

## 5. Тестирование

* Минимальный набор XSpec-тестов лежит в `tests/xspec/`.
  Запуск: `vendor/bin/xspec tests/xspec/<file>.xspec` (требуется Java/XSpec >= 2.5).
* При добавлении атома или публичного режима — пишите отдельный сценарий.
* Для отладки используйте `playground/index.php` (доступен только в `DEBUG=true`).

## 6. Playbook для новых шаблонов

1. Создайте файл, добавьте шапку с описанием `Summary / Usage / Rules`.
2. Импортируйте нужные helpers (`classes.xslt`, `fields/helpers.xslt`).
3. Используйте `xsl:key` для повторных выборок.
4. Для rich-text выводите `node()` через `xsl:copy-of`.
5. Добавьте XSpec-тест и обновите гайд при изменении публичного API.

## 7. Частые ошибки

* **Нет `data-role="form-field"`** — перестаёт работать JS в админке.
* **Ручной `id`** — ломает привязку `<label for>`, а также ссылки из JS.
* **`disable-output-escaping`** — приводит к XSS; используйте `xsl:copy-of`.
* **Переход на `xsl:include`** вместо `xsl:import` — ломает приоритет overrides.

Следуйте этим правилам, и новые разработчики смогут быстро понимать и
расширять XSLT-пайплайн без риска регрессий.
