# Документация по конфигурациям компонентов

## Общие сведения

Компоненты административного интерфейса Energine описываются XML-файлами с расширением `.component.xml`. Эти файлы лежат в каталоге `engine/core/modules/<module>/config/` или во вложенных подпапках конкретных модулей. Каждый файл содержит корневой элемент `<configuration>`, внутри которого задаются состояния компонента (states), наборы полей, фильтры, тулбары, источники данных и прочие параметры поведения.

XML-конфиг считывается на стороне сервера, из него формируется объект компонента и набор классов-помощников (`DataDescription`, `Toolbar`, `Form`, `GridManager` и др.), после чего соответствующие JavaScript-виджеты получают параметры в сгенерированном HTML/XSLT и подключаются к API.

## Структура конфигурации

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
    <state name="main">
        ...
    </state>
    <state name="add">
        ...
    </state>
    <!-- дополнительные состояния -->
</configuration>
```

### Состояния (`<state>`)

* Атрибут `name` задаёт уникальный идентификатор состояния. Имя совпадает с методом компонента, который будет вызван при переходе в состояние (например, `main`, `add`, `edit`).
* Атрибут `rights` ограничивает доступ по ролям. Числа обычно соответствуют значениям из ACL: `2` — изменение, `3` — создание и т. п.
* Внутри `<state>` задаются разделы с настройками: `uri_patterns`, `javascript`, `fields`, `filter`, `toolbar`, `datasource`, `templates`, `properties` и др. Набор узлов зависит от типа компонента.

### Маршруты (`<uri_patterns>`) 

Определяют URL-маски, по которым можно попасть в состояние.

```xml
<uri_patterns>
    <pattern>/add/</pattern>
    <pattern>/[int]/edit/</pattern>
</uri_patterns>
```

Плейсхолдеры (`[int]`, `[any]`, `[pageNumber]` и др.) интерпретируются роутером `Energine`. Они становятся параметрами запроса.

### JavaScript-поведение (`<javascript>`) 

Здесь указывается клиентский класс (behavior), который будет подключён в админке.

```xml
<javascript>
    <behavior name="GridManager"/>
</javascript>
```

* `GridManager` — таблицы/гриды.
* `Form` или `FileRepoForm` — формы ввода.
* `FileRepository`, `SiteSelector` и др. — специализированные поведения.

При генерации HTML имя поведения превращается в инициализацию JS-класса (см. `engine/core/modules/share/scripts/Toolbar.js`).

### Поля (`<fields>`) 

Описание структуры данных, которые компонент читает и выводит. Сервер формирует `DataDescription` и `Data` на основании этих элементов.

```xml
<fields>
    <field name="upl_title" title="FIELD_TITLE" type="string"/>
    <field name="upl_path" type="file"/>
</fields>
```

Поддерживаемые атрибуты:

* `name` — имя колонки в БД/результате запроса.
* `title` — ключ локализации или текстовая подпись.
* `type` — тип поля (`string`, `int`, `file`, `hidden`, `date`, `select`, `checkbox`, `editor`, `html`, `rtf` и др.).
* Дополнительные атрибуты (например, `outputFormat`, `format`, `readonly`, `required`, `placeholder`) передаются и серверу, и клиенту как свойства `FieldDescription`.

Для форм можно задавать скрытые поля (`type="hidden"`), файловые загрузки (`type="file"`), JSON (`type="properties"`) и т. д.

### Фильтр (`<filter>`)

Используется в состояниях с гридом для описания полей фильтрации и сортировки.

```xml
<filter>
    <field name="upl_title"/>
    <field name="upl_publication_date"/>
</filter>
```

Клиент (например `GridManager`) подставляет фильтр в запросы `get-data`.

### Тулбар (`<toolbar>`) и элементы управления (`<control>`)

Toolbar задаёт кнопки и выпадающие списки, отображающиеся над гридом или формой. Каждый `<control>` описывает отдельную кнопку, селект, разделитель и т. д.

```xml
<toolbar>
    <control id="add" title="BTN_ADD" icon="fa fa-plus" type="button" onclick="add"/>
    <control id="after_save_action" title="TXT_AFTER_SAVE_ACTION" type="select">
        <options>
            <option id="reload">BTN_CLOSE</option>
            <option id="add">BTN_ADD</option>
        </options>
    </control>
    <control id="sep1" type="separator"/>
    <control id="close" title="BTN_CANCEL" icon="fa fa-times" type="button" onclick="close"/>
</toolbar>
```

Основные атрибуты:

* `id` — уникальный идентификатор контрола.
* `title` — текст или ключ локализации. Для кнопок с иконками текст также используется как `aria-label`.
* `type` — вид элемента (`button`, `select`, `switcher`, `file`, `separator`, `link`).
* `icon` — CSS-класс иконки Font Awesome (например, `fa fa-plus`). Отрисовывается в XSLT (`engine/core/modules/share/transformers/bootstrap/components/navigation/toolbar.xslt`).
* `iconOnly="true"` — отобразить только иконку (JS-логика в `Toolbar.js`).
* `onclick` — имя действия/метода в JS или на сервере, вызываемого при клике.
* Дополнительные атрибуты: `disabled`, `hidden`, `tooltip`, `confirm`, `multiple`, `accept`, `behavior`, `target`, `useDefaultIcon` и др.

#### Элементы выбора (`<options>`)

Для `type="select"` или `type="switcher"` вложенный `<options>` задаёт список вариантов. Значения (атрибут `id`) уходят в JS, текст локализуется через словарь.

```xml
<control id="after_save_action" type="select">
    <options>
        <option id="reload">BTN_CLOSE</option>
        <option id="add">BTN_ADD</option>
    </options>
</control>
```

### Источники данных и обработчики

Некоторые компоненты дополнительно определяют:

* `<datasource>` — описание SQL-запроса или ссылается на класс-источник (`DataSet`).
* `<properties>` — произвольные параметры, доступные компоненту (`<property name="itemsPerPage">20</property>`).
* `<templates>` — переопределение XSL-шаблонов.
* `<dependencies>` — внешние ресурсы (скрипты, стили).

Пример (см. `engine/core/modules/apps/config/ExtendedFeed.component.xml`):

```xml
<state name="main">
    <datasource>
        <recordset name="main">
            <query>SELECT ...</query>
        </recordset>
    </datasource>
</state>
```

## Жизненный цикл состояния

1. Роутер сопоставляет URL `/<module>/<component>/<state>/` с нужным состоянием, используя `<uri_patterns>`.
2. Компонент загружает `DataDescription` и `Data` согласно секциям `fields` и `datasource`.
3. На основе `<toolbar>` формируется объект `Toolbar` и рендерится XSLT-шаблоном `toolbar.xslt`. Клиентский скрипт `Toolbar.js` инициализирует кнопки, обрабатывает атрибуты `icon`, `iconOnly`, `aicon` и т. д.
4. JS-поведение из `<javascript>` получает параметры компонента и подписывается на события тулбара.
5. Действия пользователей (клики по кнопкам, отправка формы) вызывают методы `onclick` на клиенте, которые делают AJAX-запросы к состояниям (`/save/`, `/get-data/`, `/delete/` и т. п.).

## Практические рекомендации

1. **Организуйте структуру по сценариям.** Состояния `main`, `add`, `edit`, `delete`, `save` принято включать почти во все компоненты CRUD. Дополнительные состояния (`move`, `upload`, `view`) описывают вспомогательные потоки.
2. **Используйте локализацию.** Значения `title`, `BTN_*`, `TXT_*`, `FIELD_*` берутся из словаря языка. Это гарантирует перевод интерфейса.
3. **Настраивайте права.** Для потенциально опасных операций (`delete`, `save`, `move`) указывайте `rights="2"` или выше, чтобы админка сама скрывала кнопки для пользователей без прав.
4. **Работайте с иконками аккуратно.** `icon` принимает полный класс Font Awesome (`fa fa-pencil`). Дополнительный класс `fa-fw` выравнивает ширину (используйте при необходимости). Для кнопок без текста добавляйте `iconOnly="true"`, чтобы тулбар не оставлял пустое место.
5. **Добавляйте разделители.** `type="separator"` визуально группирует кнопки в тулбаре. ID можно опустить или задать уникальный (`sep1`).
6. **Используйте скрытые поля.** В формах задайте все поля, которые должны отправляться на сервер, включая первичный ключ и метаданные (`type="hidden"`).
7. **Соблюдайте порядок полей.** Порядок `<field>` соответствует порядку отображения. Для табличных представлений это определяет порядок колонок.
8. **Валидация и форматирование.** Атрибуты полей передаются в JS-формы (`required`, `pattern`). Для дат и чисел указывайте `format`, `outputFormat`, чтобы сервер/клиент корректно конвертировали значение.
9. **Повторно используйте поведения.** Если компонент — таблица, укажите `GridManager`. Для форм — `Form`. Специализированные классы лежат в `engine/core/modules/<module>/scripts/`.
10. **Расширяйте через XSLT/JS.** Если стандартных элементов не хватает, добавьте пользовательский шаблон в `<templates>` и подключите собственный скрипт через `<javascript>`.

## Отладка и расширение

* **Логика загрузки конфигураций** реализована в PHP-классах модулей (`engine/core/modules/*/components/*`). При необходимости добавления новых типов контролов добавьте XSL-шаблон и обработку в JS (`Toolbar.js`).
* **Проверка доступности**: вывод админки зависит от прав пользователя. Если кнопка не отображается, убедитесь, что права (`rights`) позволяют её видеть.
* **Диагностика данных**: используйте логгеры `Energine` или вывод SQL-запросов, чтобы проверить корректность `<datasource>`.
* **Изменение без перезапуска.** XML-файлы читаются при каждом запросе, поэтому изменения в `.component.xml` применяются сразу (кроме кеширующих систем).

## Пример рабочего цикла

Рассмотрим фрагмент `engine/core/modules/share/config/Grid.component.xml`:

1. `state name="main"` — грид с кнопками `view`, `add`, `edit`, `delete`. Для каждой кнопки указан `icon` (`fa fa-eye`, `fa fa-plus`, `fa fa-pencil`, `fa fa-trash`).
2. Состояния `add` и `edit` используют поведение `Form`, содержат выпадающий список `after_save_action`, разделитель и кнопку закрытия.
3. Состояние `getRawData` описывает маршруты AJAX для загрузки данных гридом.

Этот шаблон можно использовать для большинства CRUD-компонентов.

## Чек-лист при создании нового компонента

1. Создайте файл `MyComponent.component.xml` в соответствующем каталоге.
2. Опишите состояния и маршруты: `main` (список), `add`/`edit` (формы), `save`/`delete` (обработчики), `getRawData` (AJAX).
3. Для каждого состояния:
    * Укажите `rights`, если нужно ограничение.
    * Добавьте `<javascript>` с подходящим поведением.
    * Опишите `<fields>` и/или `<filter>`.
    * Сформируйте `<toolbar>` с кнопками, иконками и действиями.
    * Пропишите `<datasource>` или позвольте компоненту загрузить данные по умолчанию.
4. Проверьте, что в PHP-компоненте реализованы методы для всех состояний и `onclick`-обработчиков.
5. Обновите локализации для новых `title`/`option`.
6. Перезапустите/обновите страницу админки и убедитесь, что иконки отображаются корректно.

Эта документация охватывает основные концепции конфигов компонентов. За подробностями смотрите исходный код классов `Component`, `Toolbar`, `DataDescription`, а также XSLT-шаблоны в `engine/core/modules/share/transformers/bootstrap/components/`.
