# Стандарт кодирования XSLT для Codex

## Назначение документа

Этот документ описывает договорённости команды Codex по оформлению XSLT-стилей. Цель стандарта — сделать трансформации понятными для новичков и устойчивыми при сопровождении. Рекомендации охватывают подходы к построению XPath, организации шаблонов, структуре файлов и оформлению HTML.

## Основные принципы

1. **Читаемость важнее микропроизводительности.** Предпочитайте конструкции, которые легко понимают коллеги. Оптимизации выполняйте только после измерений и без ухудшения читаемости.
2. **Декларативный подход по умолчанию.** Используйте механизм сопоставления шаблонов (`match` + `xsl:apply-templates`) вместо императивных обходов, чтобы код оставался модульным.
3. **Модульность и переиспользование.** Разделяйте крупные стили на небольшие файлы, подключайте общие блоки через `xsl:import` / `xsl:include`, передавайте данные явно через параметры.
4. **Единообразие оформления.** Соблюдайте одинаковые соглашения по именованию, форматированию, организации директорий и комментариев, чтобы любой модуль выглядел узнаваемо.

## XPath и работа с шаблонами

### Рекомендуемые приёмы

- В шаблонах для обхода дочерних узлов используйте `<xsl:apply-templates>` и при необходимости атрибут `mode`.
- Сохраняйте XPath-выражения относительными к текущему контексту, избегая лидирующего `//` внутри шаблонов.
- Выносите длинные или повторяющиеся XPath в переменные с атрибутом `select` и говорящими именами.
- Для частых выборок по атрибутам или ключам создавайте `<xsl:key>` с комментариями о назначении.
- Предпочитайте буквальные элементы и атрибуты с фигурными скобками вместо `xsl:element`/`xsl:attribute`, когда имена известны заранее.
- Используйте «шаблон идентичности» (`xsl:copy` + `xsl:apply-templates`) как безопасную базу для копирования дерева и переопределяйте только отличающиеся узлы.

### Чего избегать

| Антипаттерн | Чем заменить | Обоснование |
| --- | --- | --- |
| `//` в начале XPath | Относительные пути или переменные с нужным контекстом | Ускоряет обработку и делает намерение очевидным. |
| Длинные XPath в одну строку | Переменные, ключи, вспомогательные шаблоны | Повышает читабельность и переиспользование. |
| Массовое применение `<xsl:for-each>` | `xsl:apply-templates` с режимами | Сохраняет декларативность и облегчает расширение. |
| Статические элементы через `xsl:element`/`xsl:attribute` | Буквальные элементы | Сокращает объём кода. |
| Повторяющиеся выражения | Вынос в переменные или функции | Исключает расхождения и улучшает производительность. |
| Пустые конструкции `xsl:if` / `xsl:when` / `xsl:for-each` | Удаление таких блоков | Уменьшает шум. |
| `xsl:variable` с вложенным `xsl:value-of` | Атрибут `select` у переменной | Делает объявление короче и быстрее. |

## Именование и структура файлов

- Даём осмысленные имена шаблонам, режимам и переменным (`renderMainMenu`, `pageHeaderMode`). Однобуквенные имена допускаются только внутри коротких выражений-помощников.
- Повторно используемые шаблоны и функции выносим в отдельные файлы (`common/layout.xslt`, `common/formatting.xslt`) и подключаем через `xsl:include` или `xsl:import`.
- Каждый файл начинается с комментария, описывающего назначение, ожидаемый контекст и основные точки расширения.

### Организация модулей и каталогов

- Все трансформеры ядра размещаются внутри `engine/core/modules/<module_name>/transformers/`.
- В модуле `share` придерживаемся следующей структуры:
  - `engine/core/modules/share/transformers/base.xslt` содержит общие шаблоны (например, подключение параметров, базовые определения `mode`).
  - `engine/core/modules/share/transformers/include.xslt` объединяет подключаемые части и экспортируемые публичные шаблоны.
  - Точечные трансформеры (`single.xslt`, `list.xslt`, `media.xslt` и т.п.) отвечают за отдельные сценарии рендеринга. Для новых сценариев создавайте отдельный файл с названием по назначению (`shareToolbar.xslt`, `shareCarousel.xslt`) и подключайте его из `include.xslt`.
  - Дополнительные утилиты (`form-field-wrapper.xslt`, `filters_tree_editor.xslt`) группируются по назначению и документируются в заголовке файла, чтобы поддерживать каталог читаемым.
- Если модуль использует общие компоненты (например, SEO, авто), делите их на три слоя: `base.xslt` (общие правила), специализированные трансформеры и файлы-агрегаторы с `xsl:import` для переопределения.

## Комментарии и документация

- Комментарии объясняют «почему», а не «что». Фиксируйте бизнес-правила, нестандартные XPath, соглашения по параметрам и ключам.
- Для генерации комментариев в результирующем документе используйте `<xsl:comment>`, для внутренних пометок — `<!-- ... -->`.
- При добавлении нового ключа или режима документируйте его использование в начале файла.

## Рефакторинг и код-ревью

- После добавления шаблона проводите рефакторинг: убирайте дубли, делайте XPath короче, разделяйте крупные конструкции на функции/шаблоны.
- На ревью обращайте внимание на возможности перехода от pull-паттернов к push, укорачивайте XPath и выносите общие блоки в модули.
- Перед коммитом проверяйте, что все подключаемые файлы задокументированы, а новые параметры явно передаются в шаблоны.

## HTML и UI-оформление

- Генерируемая разметка должна соответствовать Bootstrap 5+ (классы контейнеров, сетки, компонентов). Проверяйте совместимость с актуальной документацией Bootstrap.
- При добавлении новых компонентов учитывайте будущую интеграцию MDBootstrap: используйте семантичные классы и избегайте жёстко зашитых цветовых схем, чтобы проще подключать дополнительные CSS/JS.
- Избегайте устаревших классов Bootstrap 3/4 и inline-стилей, если есть готовые утилиты в Bootstrap 5.

## Дополнительные рекомендации

- **Контроль версий.** Добавьте в `.gitignore` артефакты сборки XSLT или кэш трансформаций, если они генерируются автоматически.
- **Профилирование.** Для тяжёлых трансформаций измеряйте производительность (например, Saxon `-TP`) и документируйте найденные узкие места и принятые решения.
- **Обработка ошибок.** Явно сигнализируйте о критических ситуациях через `<xsl:message terminate="yes">` и используйте осмысленные сообщения для логирования.
- **Обновление стандарта.** Пересматривайте документ при появлении новых практик. В шаблонах оставляйте TODO с ссылкой на соответствующий пункт стандарта, чтобы облегчить навигацию по техническому долгу.
