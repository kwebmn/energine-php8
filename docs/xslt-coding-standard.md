# Стандарт кодирования XSLT для Codex

## Назначение документа

Этот документ описывает договорённости команды Codex по оформлению XSLT-стилей и дополняет их практическими рекомендациями. Цель стандарта — сделать трансформации понятными для новичков и устойчивыми при сопровождении, а также зафиксировать конкретные шаги по улучшению существующего кода.

## Основные принципы

1. **Читаемость важнее микропроизводительности.** Предпочитайте конструкции, которые легко понимают коллеги. Оптимизации выполняйте только после измерений и без ухудшения читаемости.
2. **Декларативный подход по умолчанию.** Используйте механизм сопоставления шаблонов (`match` + `xsl:apply-templates`) вместо императивных обходов, чтобы код оставался модульным.
3. **Тестируемость и модульность.** Разделяйте крупные стили на небольшие файлы, повторно используйте общие блоки через `xsl:import` / `xsl:include`, передавайте данные явно через параметры.
4. **Единообразие оформления.** Соблюдайте одинаковые соглашения по именованию, форматированию, организации директорий и комментариев, чтобы любой модуль выглядел узнаваемо.

## XPath и работа с шаблонами

### Рекомендуемые приёмы

- В шаблонах для обхода дочерних узлов используйте `<xsl:apply-templates>` и при необходимости атрибут `mode`.
- Сохраняйте XPath-выражения относительными к текущему контексту, избегая лидирующего `//` внутри шаблонов.
- Выносите длинные или повторяющиеся XPath в переменные с атрибутом `select` и говорящими именами.
- Для частых выборок по атрибутам или ключам создавайте `<xsl:key>` с комментариями о назначении.
- Предпочитайте буквальные элементы и атрибуты с фигурными скобками вместо `xsl:element`/`xsl:attribute`, когда имена известны заранее.
- Используйте «шаблон идентичности» (`xsl:copy` + `xsl:apply-templates`) как безопасную базу для копирования дерева и переопределяйте только отличающиеся узлы.

### Чего избегать

| Антипаттерн | Чем заменить | Обоснование |
| --- | --- | --- |
| `//` в начале XPath | Относительные пути или переменные с нужным контекстом | Ускоряет обработку и делает намерение очевидным.
| Длинные XPath в одну строку | Переменные, ключи, вспомогательные шаблоны | Повышает читабельность и переиспользование.
| Массовое применение `<xsl:for-each>` | `xsl:apply-templates` с режимами | Сохраняет декларативность и облегчает расширение.
| Статические элементы через `xsl:element`/`xsl:attribute` | Буквальные элементы | Сокращает объём кода.
| Повторяющиеся выражения | Вынос в переменные или функции | Исключает расхождения и улучшает производительность.
| Пустые конструкции `xsl:if` / `xsl:when` / `xsl:for-each` | Удаление таких блоков | Уменьшает шум.
| `xsl:variable` с вложенным `xsl:value-of` | Атрибут `select` у переменной | Делает объявление короче и быстрее.

## Именование и структура файлов

- Даём осмысленные имена шаблонам, режимам и переменным (`renderMainMenu`, `pageHeaderMode`). Однобуквенные имена допускаются только внутри коротких выражений-помощников.
- Повторно используемые шаблоны и функции выносим в отдельные файлы (`common/layout.xslt`, `common/formatting.xslt`) и подключаем через `xsl:include` или `xsl:import`.
- Каждый файл начинается с комментария, описывающего назначение, ожидаемый контекст и основные точки расширения.

## Комментарии и документация

- Комментарии объясняют «почему», а не «что». Фиксируйте бизнес-правила, нестандартные XPath, соглашения по параметрам и ключам.
- Для генерации комментариев в результирующем документе используйте `<xsl:comment>`, для внутренних пометок — `<!-- ... -->`.
- При добавлении нового ключа или режима документируйте его использование в начале файла.

## Тестирование и рефакторинг

- После добавления шаблона проводите рефакторинг: убирайте дубли, делайте XPath короче, разделяйте крупные конструкции на функции/шаблоны.
- Поддерживайте автоматические проверки (XSpec, unit-тесты проекта), добавляйте регрессионные тесты на обнаруженные дефекты.
- На ревью обращайте внимание на возможности перехода от pull-паттернов к push, укорачивайте XPath и выносите общие блоки в модули.

## Наблюдаемые проблемы и предложения по улучшению

- **Глобальные поиски вместо контекстных обращений.** В `site/modules/default/transformers/energine.xslt` встречаются выражения вроде `//component[@name='langSwitcher']` и `//property[@name='canonical']`. Предлагаем завести шаблон, обрабатывающий `component[@name='langSwitcher']` через `xsl:apply-templates`, и сохранить свойства страницы в переменные с привязкой к узлу `document`, чтобы избавиться от глобальных сканов и ускорить рендеринг.
- **Избыточный `xsl:for-each`.** В том же файле `energine.xslt` для генерации alternate-ссылок используется `<xsl:for-each>`. Стоит заменить на `xsl:apply-templates` с отдельным режимом, что позволит переиспользовать логику переключателя языка в других контекстах и упростить unit-тесты.
- **Повторение XPath и вычислений.** В `site/modules/default/transformers/bootstrap/content.xslt` и `bootstrap/header.xslt` много обращений к `//property[...]` и `//translation[...]`. Рекомендуем определить ключи для переводов, а свойства страницы передавать через параметры или верхнеуровневые переменные, чтобы сократить количество повторных вычислений и устранить риск несогласованного вывода.
- **Небезопасный HTML через `disable-output-escaping`.** Шаблон `component[@name='childDivisions']` в `bootstrap/content.xslt` выводит HTML из `DescriptionRtf` с `disable-output-escaping="yes"`. Предлагаем внедрить единый фильтр очистки или использовать отдельный шаблон, который преобразует допустимый поднабор HTML, чтобы снизить риск XSS и облегчить тестирование.
- **Отсутствие ключей для меню и языков.** Меню (`bootstrap/header.xslt`) и переключатель языков используют прямые фильтры без ключей. Введение ключей `xsl:key name="menu-by-id" match="record" use="field[@name='Id']"` и `key name="translation"` ускорит навигацию и упростит выборку связанных элементов при росте данных.

## Дополнительные рекомендации

- **Контроль версий.** Добавьте в `.gitignore` артефакты сборки XSLT или кэш трансформаций, если они генерируются автоматически.
- **Профилирование.** Для тяжёлых трансформаций измеряйте производительность (например, Saxon `-TP`) и документируйте найденные узкие места и принятые решения.
- **Обработка ошибок.** Явно сигнализируйте о критических ситуациях через `<xsl:message terminate="yes">` и используйте осмысленные сообщения для логирования.
- **Обновление стандарта.** Пересматривайте документ при появлении новых практик. В шаблонах оставляйте TODO с ссылкой на соответствующий пункт стандарта, чтобы облегчить навигацию по техническому долгу.

