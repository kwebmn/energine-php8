# Руководство по сборке фронтенда через Vite

Документ описывает, как настроен процесс сборки клиентских ресурсов Energine при помощи Vite, какие конфигурационные файлы задействованы и какие итоговые файлы формируются. Материал ориентирован на разработчиков, которые сопровождают проект и разворачивают обновления.

---

## 1. Общие сведения

- **Цель сборки** – собрать современными средствами (Vite + Rollup) весь клиентский код: базовые библиотеки, публичный фронтенд Energine и расширенный интерфейс для авторизованных пользователей.
- **Каталог с результатом** – `<корень проекта>/assets`. Все JS/CSS бандлы имеют стабильные имена, что упрощает ссылки в XSLT и кеширование.
- **Пакетные зависимости** – достаточно `vite` в `devDependencies`. Библиотеки вроде Bootstrap ставятся через Composer и попадают в `vendor/`, поэтому не занимают место в репозитории.

---

## 2. Как запустить сборку

1. Установите PHP-зависимости, чтобы в `vendor/` появился Bootstrap и прочие пакеты:
   ```bash
   composer install
   ```
2. Установите npm-зависимости (при первом запуске либо после обновления `package.json`):
   ```bash
   npm install
   ```
3. Соберите клиентские ресурсы:
   ```bash
   npm run build
   ```
   Скрипт вызывает `node engine/vite/build.mjs`, который по очереди запускает Vite для четырёх целей: `energine.vendor`, `energine.extended.vendor`, `energine`, `energine.extended`.
4. Проверьте содержимое каталога `assets/`. Первый бандл очищает каталог, остальные дописываются в существующие файлы.

> ⚠️ **Режим watch** напрямую не поддержан. Для интерактивной разработки рекомендуем поднять Vite Dev Server и прокинуть ассеты через прокси (см. заметки по миграции ES-модулей).

---

## 3. Структура конфигурации

### 3.1 `engine/vite/config.js`

Ключевые элементы:

- **Пути**: экспортируются переменные `rootDir`, `repoRoot`, `entriesDir`, `outputDir`, `engineDir`, `siteDir`, `vendorDir`. Благодаря этому все entry-файлы и build-скрипты могут оперировать абсолютными путями независимо от текущего каталога, включая доступ к зависимостям из Composer.
- **Список бандлов** (`buildTargets`): описывает все точки входа с привязкой к файлам внутри `engine/vite/entries/`.
- **Фабрика конфигурации** (`createBuildConfig`):
  - Отключает копирование `publicDir`, чтобы ничего лишнего не попадало в `assets/`.
  - Включает предсказуемые имена JS/CSS (`entryFileNames`, `assetFileNames`) и запрещает разбиение CSS на части.
  - Регистрирует алиасы `engine` и `site`, указывающие на соответствующие каталоги в корне репозитория. Благодаря этому import в entry-файлах выглядит как `import 'engine/core/...';`, а не через длинные относительные пути или устаревшие `scripts/`.
- **Конфиг по умолчанию** – экспортируется для совместимости с командой `vite build --config engine/vite/config.js`, но основной сценарий использует `build.mjs`.

### 3.2 `engine/vite/build.mjs`

Скрипт-оркестратор, который:

- Вычисляет базовые каталоги (корень репозитория, директория с entry, целевой каталог `assets`).
- Проходит по `targets` и для каждой цели вызывает `vite.build` с общими настройками.
- Для вендорских бандлов (`energine.vendor`, `energine.extended.vendor`) выставляет формат `iife` и контекст `window`, чтобы сохранить глобальные побочные эффекты (старый код ожидает глобальные переменные).
- Для прикладных бандлов (`energine`, `energine.extended`) оставляет формат `es`, позволяющий загружать их как модули.
- Нормализует имена CSS-файлов (возвращает `${name}.css`), чтобы XSLT шаблоны могли линковать предсказуемые пути.

### 3.3 Точки входа (`engine/vite/entries/`)

Каждый entry-файл описывает конкретный слой интерфейса и импортирует собственный CSS:

- **`energine.vendor.entry.js`** – минимальный набор для всех пользователей: Bootstrap JS/CSS из `vendor/twbs/bootstrap`, установленного через `composer install`.
- **`energine.extended.vendor.entry.js`** – подборка тяжёлых библиотек, необходимых только авторизованным (CKEditor, jsTree, CodeMirror и т.д.). И jQuery, и jsTree подключаются из Composer-пакетов, а в репозитории остаются только лёгкие заглушки для режима отладки. jsTree устанавливается из npm-архива через Composer и импортируется из `vendor/components/jstree/dist`.
- **`energine.entry.js`** – основной модуль Energine, слой аутентификации гостя (`SignIn`, `RecoverPassword`) и сценарии публичного сайта (`site/modules/default/scripts/default.js`). Экспортирует API Energine как модуль.
- **`energine.extended.entry.js`** – весь административный функционал: GridManager, Form, Toolbar, PageEditor, SiteManager, контролы для автотеста и т.д.

Стили лежат в `engine/vite/entries/styles/` и используют алиасы вместо сырого пути `stylesheets/`. Например, `admin.css` импортирует `engine/core/modules/share/stylesheets/form.css` и другие административные стили.

---

## 4. Итоговые файлы в `assets/`

После сборки в каталоге `assets/` появятся следующие артефакты:

| Имя файла | Назначение | Где подключается |
| --- | --- | --- |
| `energine.vendor.js` / `energine.vendor.css` | Базовые вендорные зависимости (Bootstrap). Нужны всем пользователям. | `engine/core/modules/share/transformers/document.xslt` — подключаются без условий в продакшене. |
| `energine.extended.vendor.js` / `energine.extended.vendor.css` | Административные сторонние библиотеки: редактор, файловый API, дерево, CodeMirror. Загружаются только для пользователей с `is_user = 1`. | Там же, в `document.xslt`, внутри условия по авторизации. |
| `energine.js` / `energine.css` | Публичный модуль Energine и базовая тема. JS-файл грузится как модуль и содержит `bootEnergine`, CSS — общие стили сайта. | `document.xslt` (JS — в `<script type="module">`, CSS — линк всегда). |
| `energine.extended.js` / `energine.extended.css` | Логика админ-интерфейса (grid, формы, тулбары) и дополнительные стили интерфейса управления сайтом. | Подключаются только при входе пользователя (`is_user = 1`). |
| `32px.png` и другие ресурсы | Статичные файлы, которые были импортированы внутри CSS (например, иконки из темы jsTree). Важно хранить их вместе с бандлами, чтобы браузер находил ресурсы по путям из CSS. | Используются прозрачным образом через ссылки внутри CSS. |

> Имена файлов не меняются от сборки к сборке, поэтому XSLT-шаблоны не требуют правок при обновлениях. Однако при деплое важно заменить весь каталог `assets/`, чтобы пользователь получил свежие файлы.

---

## 5. Где используются бандлы

- **`engine/core/modules/share/transformers/document.xslt`** – основной шаблон документов. В продакшене подключает все JS/CSS из `assets/`, а также активирует расширенные бандлы для авторизованных пользователей. Здесь же настраивается глобальный объект Energine и запускается `START_ENERGINE_JS`.
- **`site/modules/default/transformers/energine.xslt`** – шаблон публичного сайта. В режиме отладки продолжает ссылаться на старые пути (`stylesheets/default/…`, `scripts/default/…`) для совместимости, но в продакшене полагается на собранные бандлы.
- **Компоненты административной панели** (Grid, Form, Toolbar) – используют расширенные файлы; работать без `energine.extended.*` они не смогут.

---

## 6. Советы по отладке и сопровождению

- **Предупреждения Vite о шрифтах и картинках**: сообщения вида «didn't resolve at build time» допустимы. Бандлер оставляет пути нетронутыми, а реальные файлы обслуживает PHP (через `/images/`, `/resizer/` и т.п.). Главное, чтобы файлы существовали.
- **Импорты старого формата**: если в entry-файле или CSS всё ещё встречается путь наподобие `../../../../scripts/...`, замените его на алиас `engine/...` или `site/...`. При неправильном пути сборка упадёт.
- **Размер бандлов**: `energine.extended.vendor.js` превышает 1 МБ из‑за тяжёлых библиотек. Это ожидаемо. При необходимости можно добавить динамический импорт и разделить по страницам, но пока достаточно статического набора.
- **Очистка `assets/`**: автоматические команды (как `npm run build`) уже очищают каталог перед сборкой в рамках первого таргета. Не удаляйте файлы вручную, если в каталоге присутствует что-то, что больше нигде не хранится.
- **Совместимость с dev-сервером**: текущая конфигурация ориентирована на production-сборку. Если нужен Hot Module Reloading, придётся добавить отдельный конфиг и проксирование, либо использовать традиционную схему с локальными `scripts/`.

---

## 7. Краткий чек-лист перед деплоем
1. Убедитесь, что все изменения в JS/CSS учтены в соответствующих entry-файлах.
2. Выполните `npm run build` и дождитесь успешного завершения без ошибок.
3. Проверьте обновлённые файлы в `assets/` (дата/время, размер).
4. Залейте весь каталог `assets/` на сервер и обновите права доступа при необходимости.
5. Протестируйте:
   - публичную страницу в режиме гостя;
   - административный интерфейс под авторизованным пользователем;
   - ключевые сценарии, зависящие от CKEditor, файлового менеджера, jsTree и т.д.

---

## 8. Ссылки и смежные документы

- Документация по миграции на ES-модули: `docs/es-modules-phase*.md`.
- Настройки главного XSLT-шаблона: `engine/core/modules/share/transformers/document.xslt`.
- Vite (официальная документация): <https://vitejs.dev/>

Если понадобилось добавить новый бандл или изменить структуру существующих — обновляйте `buildTargets`, соответствующий entry-файл и XSLT-шаблон, после чего пересоберите проект. В репозитории не принято хранить автогенерируемые файлы под другими именами, поэтому придерживайтесь описанной структуры.
